<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šç¶“ç‡ŸåŠ©æ‰‹ V.10.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --bg-color: #FFF8E1; --primary-color: #FFAB40; --text-color: #5D4037; }
        body { 
            padding: 20px; background-color: var(--bg-color);
            background-image: radial-gradient(#FFD54F 2px, transparent 2px);
            background-size: 30px 30px;
            font-family: "Microsoft JhengHei", sans-serif; 
            color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }
        .main-container { 
            background-color: #fff; padding: 20px; border-radius: 25px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); border: 3px solid #FFE082; 
            flex: 1; display: flex; flex-direction: column;
        }
        .btn { border-radius: 50px; font-weight: bold; margin-bottom: 5px; }
        .btn-purple { background-color: #AB47BC; color: white; }
        
        .canvas-area {
            position: relative; border: 4px dashed #FFB74D; border-radius: 15px;
            background-color: #FFF; margin: 0 auto; display: inline-block;
        }
        
        /* å´é‚Šæ¬„å®¹å™¨ */
        .student-sidebar {
            background: #E1F5FE; border: 2px solid #81D4FA; border-radius: 15px; padding: 10px;
            height: 100%; overflow-y: auto; display: flex; flex-direction: column; position: relative;
        }
        .student-list-content { flex: 1; overflow-y: auto; margin-top: 10px; }
        
        /* å®‰å…¨é–é®ç½© */
        .sidebar-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 10;
            display: flex; justify-content: center; align-items: center;
            border-radius: 13px; text-align: center; color: #78909C; font-weight: bold;
            backdrop-filter: blur(2px); cursor: not-allowed;
        }
        .sidebar-mask.hidden { display: none; }

        /* å­¸ç”Ÿæ¨™ç±¤ */
        .student-tag {
            background: #FFF; border: 1px solid #039BE5; padding: 8px; margin-bottom: 5px; border-radius: 8px;
            cursor: pointer; font-weight: bold; color: #0277BD; transition: all 0.2s; text-align: center; user-select: none;
        }
        .student-tag:hover { background: #81D4FA; color: white; transform: translateX(5px); }
        .student-tag:active { transform: scale(0.95); }
        
        .student-tag.used { background-color: #ECEFF1; color: #90A4AE; border-color: #CFD8DC; }
        .student-tag.used:hover { background-color: #B0BEC5; color: white; }

        .student-draggable { cursor: grab; }
        
        .footer { margin-top: auto; text-align: center; color: #8D6E63; padding-top: 20px; border-top: 2px dashed #FFCC80; }
        .footer a { background-color: #FF7043; color: white; padding: 5px 15px; border-radius: 20px; text-decoration: none; }
        
        .manual-input-group { background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
        
        .table-custom th { background-color: #FFE082; color: #5D4037; text-align: center; }
        .tab-pane { height: 100%; overflow-y: auto; }
        
        input.target-input:focus { border: 2px solid #FFAB40; background-color: #FFF8E1; box-shadow: 0 0 8px rgba(255, 171, 64, 0.5); }
        input.active-target { border: 2px solid #FF5722 !important; background-color: #FFCCBC !important; }

        .undo-bar { margin-bottom: 10px; text-align: right; }
    </style>
</head>
<body>

<div class="container-fluid main-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="m-0" style="color:#E65100;">ğŸ« ç­ç´šç¶“ç‡ŸåŠ©æ‰‹ <small class="fs-6 text-muted">V.10.0</small></h3>
        <div>
            <input type="file" id="excelInput" accept=".xlsx, .xls" style="display: none;" onchange="importStudentExcel(this)">
            <button class="btn btn-sm btn-purple" onclick="downloadExampleExcel()">ğŸ“¥ ä¸‹è¼‰ç¯„ä¾‹</button>
            <button class="btn btn-sm btn-purple" onclick="document.getElementById('excelInput').click()">ğŸ“¤ åŒ¯å…¥åå–®</button>
            <div class="vr mx-2"></div>
            <button class="btn btn-sm btn-outline-primary" onclick="exportToWord()">ğŸ“ å­˜æˆ Word</button>
            <button class="btn btn-sm btn-outline-success" onclick="exportToExcel()">ğŸ“Š å­˜æˆ Excel</button>
        </div>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" id="seats-tab" data-bs-toggle="tab" data-bs-target="#seats-panel" type="button" onclick="switchTab('seats')">1. ğŸª‘ æ’åº§ä½</button></li>
        <li class="nav-item"><button class="nav-link" id="cadres-tab" data-bs-toggle="tab" data-bs-target="#cadres-panel" type="button" onclick="switchTab('cadres')">2. ğŸ–ï¸ æ’å¹¹éƒ¨</button></li>
        <li class="nav-item"><button class="nav-link" id="cleaning-tab" data-bs-toggle="tab" data-bs-target="#cleaning-panel" type="button" onclick="switchTab('cleaning')">3. ğŸ§¹ å®‰æ’æƒå€</button></li>
    </ul>

    <div class="tab-content p-3 bg-white border-top-0 flex-grow-1" id="myTabContent">
        
        <div class="tab-pane fade show active" id="seats-panel" role="tabpanel">
            <div class="undo-bar"><button class="btn btn-sm btn-outline-secondary" onclick="undo('seats')">â†©ï¸ ä¸Šä¸€æ­¥</button></div>
            <div class="row h-100">
                <div class="col-md-2">
                    <div class="p-3 bg-light rounded border">
                        <h6 class="fw-bold">ğŸ“ æ•™å®¤é…ç½®</h6>
                        <div class="row g-1 mb-2">
                            <div class="col-6"><label>ç›´æ’</label><input type="number" id="inputRows" class="form-control form-control-sm" value="5"></div>
                            <div class="col-6"><label>æ©«åˆ—</label><input type="number" id="inputCols" class="form-control form-control-sm" value="6"></div>
                        </div>
                        <button class="btn btn-primary btn-sm w-100" onclick="initGridSystem()">âœ¨ ç”Ÿæˆåº§ä½</button>
                        <hr>
                        <h6 class="fw-bold">ğŸ› ï¸ å·¥å…·</h6>
                        <button class="btn btn-secondary btn-sm w-100" onclick="addTeacherDesk()">ğŸ‘©â€ğŸ« è¬›æ¡Œ</button>
                        <button class="btn btn-dark btn-sm w-100" onclick="addBlackboard()">ğŸ« é»‘æ¿</button>
                        <button class="btn btn-warning btn-sm w-100 text-dark" onclick="addDoor()">ğŸšª æ–°å¢é–€</button>
                        <button class="btn btn-outline-primary btn-sm w-100 mt-1 fw-bold" style="border-style:dashed;" onclick="addFreeSeat()">âœ¨ ä»»æ„ä½ç½®</button>
                        <button class="btn btn-info btn-sm w-100 text-white mt-1" onclick="addCustomObject()">ğŸ“¦ æ–°å¢ç‰©é«”</button>
                        <button class="btn btn-danger btn-sm w-100 mt-2" onclick="deleteSelected()">ğŸ—‘ï¸ åˆªé™¤é¸å–</button>
                        <button class="btn btn-outline-danger btn-sm w-100 mt-1" onclick="clearAllSeats()">â™»ï¸ å…¨éƒ¨æ¸…ç©º</button>
                        <button class="btn btn-outline-dark btn-sm w-100 mt-1" onclick="rotateCanvas()">ğŸ”„ è¦–è§’åˆ‡æ›</button>
                    </div>
                </div>
                <div class="col-md-8 text-center">
                    <div class="canvas-area" id="canvas-container" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <canvas id="c" width="800" height="600"></canvas>
                    </div>
                    <small class="text-muted mt-1 d-block">ğŸ’¡ æ‹–æ›³å¯è‡ªå‹•äº¤æ›åº§ä½ (å«è‡ªç”±åº§) | è™›ç·šç‚ºè¼”åŠ©æ ¼ç·š</small>
                </div>
                <div class="col-md-2" style="height: 600px;">
                    <div class="student-sidebar">
                        <h6 class="fw-bold text-center border-bottom pb-2">ğŸ“‹ å­¸ç”Ÿåå–®</h6>
                        <div class="manual-input-group mb-2">
                            <input type="text" id="manualNameInput" class="form-control form-control-sm mb-1" placeholder="è¼¸å…¥å§“å">
                            <button class="btn btn-success btn-sm w-100 mb-1" onclick="addManualStudent()">â• åŠ å…¥åå–®</button>
                            <button class="btn btn-primary btn-sm w-100" onclick="autoSeatStudents()">âš¡ è‡ªå‹•å…¥åº§</button>
                        </div>
                        <div id="student-list-container" class="student-list-content">
                            <div class="text-muted text-center small mt-3">è«‹åŒ¯å…¥æˆ–æ‰‹å‹•è¼¸å…¥</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="cadres-panel">
            <div class="undo-bar"><button class="btn btn-sm btn-outline-secondary" onclick="undo('cadres')">â†©ï¸ ä¸Šä¸€æ­¥</button></div>
            <div class="row h-100">
                <div class="col-md-9">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="text-primary fw-bold">ğŸ–ï¸ ç­ç´šå¹¹éƒ¨åå–®</h4>
                        <button class="btn btn-success" onclick="addCadreRow()">â• å¢åŠ è·ä½</button>
                    </div>
                    <div class="alert alert-info py-2"><small>ğŸ’¡ å…ˆé»é¸å·¦å´æ¬„ä½(è®Šæ©˜è‰²)ï¼Œå†é»å³å´åå–®ã€‚äº¦å¯ç›´æ¥æ‰“å­—ã€‚</small></div>
                    <table class="table table-bordered table-hover table-custom align-middle">
                        <thead><tr><th width="30%">è·ç¨±</th><th>è² è²¬å­¸ç”Ÿ</th><th width="20%">æ“ä½œ</th></tr></thead>
                        <tbody id="cadreList"></tbody>
                    </table>
                </div>
                <div class="col-md-3">
                    <div class="student-sidebar">
                        <h6 class="fw-bold text-center border-bottom pb-2">ğŸ“‹ é»æ“Šé¸æ“‡å­¸ç”Ÿ</h6>
                        <div id="mask-cadre" class="sidebar-mask">ğŸ”’ è«‹å…ˆé»é¸<br>å·¦å´ç›®æ¨™æ¬„ä½</div>
                        <div id="picker-cadre" class="student-list-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="cleaning-panel">
            <div class="undo-bar"><button class="btn btn-sm btn-outline-secondary" onclick="undo('cleaning')">â†©ï¸ ä¸Šä¸€æ­¥</button></div>
            <div class="row h-100">
                <div class="col-md-9">
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6"><button class="btn btn-success" onclick="addCleaningTask()">â• å¢åŠ æƒå€</button></div>
                        <div class="col-md-6 text-end"><h4 class="text-success fw-bold m-0">ğŸ§¹ æƒåœ°å·¥ä½œåˆ†é…</h4></div>
                    </div>
                    <div class="alert alert-success py-2" style="--bs-alert-bg:#E8F5E9; --bs-alert-color:#2E7D32;"><small>ğŸ’¡ å…ˆé»é¸å·¦å´æ¬„ä½(è®Šæ©˜è‰²)ï¼Œå†é»å³å´åå–®ã€‚äº¦å¯ç›´æ¥æ‰“å­—ã€‚</small></div>
                    <table class="table table-bordered table-hover table-custom align-middle">
                        <thead><tr><th>å·¥ä½œé …ç›®</th><th width="15%">äººæ•¸</th><th>è² è²¬å­¸ç”Ÿ</th><th width="20%">æ“ä½œ</th></tr></thead>
                        <tbody id="cleaningList"></tbody>
                    </table>
                </div>
                <div class="col-md-3">
                    <div class="student-sidebar">
                        <h6 class="fw-bold text-center border-bottom pb-2">ğŸ“‹ é»æ“Šé¸æ“‡å­¸ç”Ÿ</h6>
                        <div id="mask-cleaning" class="sidebar-mask">ğŸ”’ è«‹å…ˆé»é¸<br>å·¦å´ç›®æ¨™æ¬„ä½</div>
                        <div id="picker-cleaning" class="student-list-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <p>2026 @ å¥•éˆè€å¸«è£½ä½œ <a href="https://www.facebook.com/share/1K5MsceXxS/?mibextid=wwXIfr" target="_blank">ğŸ‘ å¥•éˆè€å¸«çš„æ•¸ä½å‚™èª²å®¤</a></p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 0. æ ¸å¿ƒè¨­å®šèˆ‡ Hotfix ---
    (function() {
        const originalFillText = CanvasRenderingContext2D.prototype.fillText;
        CanvasRenderingContext2D.prototype.fillText = function(...args) {
            if (this.textBaseline === 'alphabetical') this.textBaseline = 'bottom';
            return originalFillText.apply(this, args);
        };
    })();
    fabric.Object.prototype.objectCaching = false;

    const canvas = new fabric.Canvas('c', { selection: true, backgroundColor: '#FFFFFF' });
    const SEAT_WIDTH = 90, SEAT_HEIGHT = 50, GAP_X = 110, GAP_Y = 80;
    
    let gridConfig = { rows: 5, cols: 6, startX: 0, startY: 0 };
    let studentMap = {}; 
    let placedStudentIds = new Set(); 
    let manualCounter = 1000;
    let activeInput = null;

    const historyStack = { seats: [], cadres: [], cleaning: [] };
    const MAX_HISTORY = 20;

    // V10.0 æ›´æ–°ï¼šå®Œæ•´å¹¹éƒ¨åå–®
    const defaultCadresList = ["ç­é•·", "å‰¯ç­é•·", "å­¸è—è‚¡é•·", "é¢¨ç´€è‚¡é•·", "è¡›ç”Ÿè‚¡é•·", "ç¸½å‹™è‚¡é•·", "åº·æ¨‚è‚¡é•·", "ç‰›å¥¶é•·", "æ¦®è­½é•·", "åœ‹èªå°è€å¸«", "è‹±èªå°è€å¸«", "æ•¸å­¸å°è€å¸«", "è‡ªç„¶å°è€å¸«", "ç¤¾æœƒå°è€å¸«"];
    let cadreData = defaultCadresList.map(role => ({ role: role, student: "" }));

    // V10.0 æ›´æ–°ï¼šå®Œæ•´æƒå€åå–®
    const defaultCleaningList = ["æ•™å®¤å…§æƒåœ°", "æ•™å®¤å…§æ‹–åœ°", "æ“¦çª—æˆ¶", "æ•´ç†é»‘æ¿", "æ•´ç†é›»è¦–é›»è…¦æ«ƒ", "ä¸€èˆ¬åƒåœ¾", "å›æ”¶åƒåœ¾", "æ´—æ‰‹å°", "é™½å°", "æ•´ç†æƒå…·", "èµ°å»Š", "å¤–æƒå€"];
    let cleaningTasks = defaultCleaningList.map(task => ({ name: task, count: 2, students: "" }));

    // --- Tab Switch Logic ---
    function switchTab(tabName) {
        activeInput = null;
        document.querySelectorAll('.active-target').forEach(e => e.classList.remove('active-target'));
        document.getElementById('mask-cadre').classList.remove('hidden');
        document.getElementById('mask-cleaning').classList.remove('hidden');
        refreshSidebars();
    }

    // --- Undo Logic ---
    function saveState(type) {
        let state;
        if (type === 'seats') {
            state = JSON.stringify({
                canvas: canvas.toJSON(['studentId', 'isStudent', 'isGridLine', 'isBlackboard', 'isTeacherDesk', 'isFreeSeat']), 
                placedStudentIds: Array.from(placedStudentIds)
            });
        } else if (type === 'cadres') state = JSON.stringify(cadreData);
        else if (type === 'cleaning') state = JSON.stringify(cleaningTasks);
        
        historyStack[type].push(state);
        if(historyStack[type].length > MAX_HISTORY) historyStack[type].shift();
    }

    function undo(type) {
        if(historyStack[type].length === 0) { alert("æ²’æœ‰æ›´æ—©çš„ç´€éŒ„äº†"); return; }
        const stateStr = historyStack[type].pop();
        const state = JSON.parse(stateStr);

        if(type === 'seats') {
            canvas.loadFromJSON(state.canvas, function() {
                placedStudentIds = new Set(state.placedStudentIds);
                canvas.renderAll();
                refreshSidebars();
            });
        } else if(type === 'cadres') { cadreData = state; renderCadres(); }
        else if(type === 'cleaning') { cleaningTasks = state; renderCleaningList(); }
    }

    canvas.on('object:modified', () => saveState('seats'));
    canvas.on('object:added', (e) => { if(!e.target.isGridLine) saveState('seats'); });

    // --- 1. Canvas é‚è¼¯ (å«è‡ªç”±åº§äº¤æ›) ---
    canvas.on('mouse:down', function(options) {
        if(options.target && options.target.isStudent) {
            options.target._startLeft = options.target.left;
            options.target._startTop = options.target.top;
        }
    });

    canvas.on('object:modified', function(options) {
        const target = options.target;
        if (!target) return;
        
        // åªè™•ç†å­¸ç”Ÿåº§ä½ (åŒ…å« Grid & Free)
        if (!target.isStudent) return;

        let closestSlot = null;
        let isGridTarget = !target.isFreeSeat;

        if (isGridTarget) {
            closestSlot = getClosestGridSlot(target.left, target.top);
            if (!closestSlot) {
                // å¦‚æœ Grid Seat æ²’å°é½Šæ ¼ç·šï¼Œå½ˆå›
                animateMove(target, target._startLeft, target._startTop);
                return;
            }
        }

        // æª¢æŸ¥ç¢°æ’ (èˆ‡ä»»ä½•å…¶ä»–åº§ä½ï¼Œç„¡è«– Grid æˆ– Free)
        let occupiedObj = null;
        canvas.getObjects().forEach(obj => {
            if (obj === target) return;
            if (!obj.isStudent) return;

            // ç¢°æ’æª¢æ¸¬é‚è¼¯
            let isCollision = false;
            
            if (isGridTarget) {
                // å¦‚æœæˆ‘æ˜¯ Grid Seatï¼Œæˆ‘åœ¨ç›®æ¨™æ ¼ç·šä½ç½®æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–äºº (äººå¯èƒ½åœ¨æ ¼ç·šä¸Šï¼Œä¹Ÿå¯èƒ½å‰›å¥½ Free Seat æ”¾åœ¨é‚£)
                isCollision = isAtPosition(obj, closestSlot.x, closestSlot.y);
            } else {
                // å¦‚æœæˆ‘æ˜¯ Free Seatï¼Œæˆ‘æª¢æŸ¥ç¾åœ¨åœçš„ä½ç½®é™„è¿‘æœ‰æ²’æœ‰äºº
                // è·é›¢æª¢æ¸¬
                let dist = Math.sqrt(Math.pow(obj.left - target.left, 2) + Math.pow(obj.top - target.top, 2));
                isCollision = dist < 30; // é è¿‘ 30px å…§ç®—ç¢°æ’
            }

            if (isCollision) occupiedObj = obj;
        });

        if (occupiedObj) {
            // [äº¤æ›]
            // å°æ–¹å»æˆ‘åŸæœ¬çš„ä½ç½®
            animateMove(occupiedObj, target._startLeft, target._startTop);
            
            // æˆ‘å»å°æ–¹çš„ä½ç½® (æˆ–è€…æˆ‘çš„ç›®æ¨™æ ¼ç·šä½ç½®)
            if (isGridTarget) {
                target.set({ left: closestSlot.x, top: closestSlot.y });
            } else {
                // å¦‚æœæˆ‘æ˜¯ Free Seatï¼Œæˆ‘æ¶å°æ–¹çš„ä½ç½® (å¦‚æœæ˜¯ Grid Seatï¼Œæˆ‘å°±åœåœ¨æ ¼å­ä¸Šï¼Œå¦‚æœæ˜¯ Freeï¼Œå°±åœåœ¨å®ƒåº§æ¨™)
                // ç‚ºäº†è¦–è¦ºæ•´é½Šï¼ŒFree Seat äº¤æ›å¾Œåœåœ¨åŸåœ°å³å¯ (å·²è¦†è“‹å°æ–¹)
                // ä½†å°æ–¹å·²ç¶“è¢«å½ˆèµ°äº†
            }
            target.setCoords();
        } else {
            // [ç„¡ç¢°æ’]
            if (isGridTarget) {
                target.set({ left: closestSlot.x, top: closestSlot.y });
            }
            target.setCoords();
        }
        canvas.renderAll();
    });

    function isAtPosition(obj, x, y) { return Math.abs(obj.left - x) < 20 && Math.abs(obj.top - y) < 20; }
    function getClosestGridSlot(x, y) {
        let col = Math.round((x - gridConfig.startX) / GAP_X);
        let row = Math.round((y - gridConfig.startY) / GAP_Y);
        if (col < 0 || col >= gridConfig.cols || row < 0 || row >= gridConfig.rows) return null;
        return { x: gridConfig.startX + col * GAP_X, y: gridConfig.startY + row * GAP_Y };
    }
    function animateMove(obj, left, top) {
        obj.animate({ left: left, top: top }, { duration: 200, onChange: canvas.renderAll.bind(canvas), easing: fabric.util.ease.easeOutQuad });
    }

    function initGridSystem() {
        saveState('seats');
        canvas.clear();
        canvas.setBackgroundColor('#FFFFFF', canvas.renderAll.bind(canvas));
        placedStudentIds.clear();

        const rows = parseInt(document.getElementById('inputRows').value) || 5;
        const cols = parseInt(document.getElementById('inputCols').value) || 6;
        const totalWidth = (cols - 1) * GAP_X + SEAT_WIDTH; 
        const startX = (canvas.width - totalWidth) / 2 + (SEAT_WIDTH/2); 
        const startY = 100 + (SEAT_HEIGHT/2); 
        gridConfig = { rows, cols, startX, startY };
        drawGridLines();

        let counter = 1;
        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                let id = counter.toString();
                let x = startX + c * GAP_X;
                let y = startY + r * GAP_Y;
                let desk = createStudentDesk(id, x, y);
                canvas.add(desk);
                counter++;
            }
        }
        addBlackboard(); addTeacherDesk();
        refreshSidebars();
    }

    function drawGridLines() {
        const oldLines = canvas.getObjects().filter(o => o.isGridLine);
        oldLines.forEach(o => canvas.remove(o));
        for(let r=0; r<gridConfig.rows; r++) {
            for(let c=0; c<gridConfig.cols; c++) {
                let x = gridConfig.startX + c * GAP_X;
                let y = gridConfig.startY + r * GAP_Y;
                const rect = new fabric.Rect({ left: x, top: y, width: SEAT_WIDTH + 10, height: SEAT_HEIGHT + 10, fill: 'transparent', stroke: '#E0E0E0', strokeWidth: 1, strokeDashArray: [5, 5], originX: 'center', originY: 'center', selectable: false, evented: false });
                rect.isGridLine = true;
                canvas.add(rect);
                canvas.sendToBack(rect);
            }
        }
    }

    function createStudentDesk(id, x, y) {
        const desk = new fabric.Rect({ width: SEAT_WIDTH, height: SEAT_HEIGHT, fill: '#FFECB3', stroke: '#FFB74D', strokeWidth: 2, rx: 10, ry: 10, originX: 'center', originY: 'center' });
        const text = new fabric.IText(id, { fontSize: 18, fill: '#5D4037', fontFamily: 'Microsoft JhengHei', fontWeight: 'bold', originX: 'center', originY: 'center', textAlign: 'center' });
        const group = new fabric.Group([desk, text], { left: x, top: y, selectable: true, hasControls: false, originX: 'center', originY: 'center' });
        group.isStudent = true; group.studentId = id; 
        return group;
    }

    function addFreeSeat() {
        saveState('seats');
        const x = canvas.width / 2;
        const y = canvas.height / 2;
        const desk = new fabric.Rect({ width: SEAT_WIDTH, height: SEAT_HEIGHT, fill: 'rgba(255, 236, 179, 0.5)', stroke: '#FF9800', strokeWidth: 2, strokeDashArray: [5, 5], rx: 10, ry: 10, originX: 'center', originY: 'center' });
        const text = new fabric.IText("è‡ªç”±åº§", { fontSize: 16, fill: '#E65100', fontFamily: 'Microsoft JhengHei', fontWeight: 'bold', originX: 'center', originY: 'center', textAlign: 'center' });
        const group = new fabric.Group([desk, text], { left: x, top: y, selectable: true, hasControls: true, originX: 'center', originY: 'center' });
        group.isStudent = true; group.isFreeSeat = true; group.studentId = "";
        canvas.add(group);
    }

    function clearAllSeats() {
        saveState('seats');
        canvas.getObjects().forEach(obj => {
            if(obj.isStudent) {
                let textObj = obj.getObjects()[1];
                let seatId = obj.studentId; 
                if (obj.isFreeSeat) {
                    textObj.set('text', "è‡ªç”±åº§");
                    obj.studentId = "";
                } else {
                    let display = (seatId && parseInt(seatId) < 1000) ? (parseInt(seatId)<10 ? `0${seatId}` : seatId) : "";
                    textObj.set('text', display);
                }
            }
        });
        placedStudentIds.clear();
        canvas.renderAll();
        refreshSidebars();
    }

    function autoSeatStudents() {
        saveState('seats');
        const keys = Object.keys(studentMap).sort((a,b) => parseInt(a) - parseInt(b));
        const seats = canvas.getObjects().filter(o => o.isStudent && !o.isFreeSeat);
        seats.sort((a, b) => (a.top - b.top) || (a.left - b.left));

        let studentIdx = 0;
        seats.forEach(seat => {
            let currentId = seat.studentId;
            let isOccupied = placedStudentIds.has(currentId) && studentMap[currentId];
            if (!isOccupied && studentIdx < keys.length) {
                while(studentIdx < keys.length && placedStudentIds.has(keys[studentIdx])) { studentIdx++; }
                if(studentIdx < keys.length) {
                    let sId = keys[studentIdx];
                    updateSeatText(seat, sId);
                    seat.studentId = sId;
                    placedStudentIds.add(sId);
                    studentIdx++;
                }
            }
        });
        canvas.renderAll(); refreshSidebars();
    }

    // --- è‡ªç”±ç‰©ä»¶ ---
    function addBlackboard() { removeObjectsByType('isBlackboard'); const rect = new fabric.Rect({ width: 500, height: 25, fill: '#2F4F2F', stroke: '#5D4037', strokeWidth: 3, rx:5, ry:5, originX: 'center', originY: 'center' }); const text = new fabric.Text("é»‘æ¿", { fontSize: 16, fill: '#fff', originX: 'center', originY: 'center' }); const group = new fabric.Group([rect, text], { left: canvas.width/2, top: 580, selectable: true, originX: 'center', originY: 'center' }); group.isBlackboard = true; canvas.add(group); }
    function addTeacherDesk() { removeObjectsByType('isTeacherDesk'); const rect = new fabric.Rect({ width: 100, height: 50, fill: '#A1887F', stroke: '#5D4037', strokeWidth: 2, originX: 'center', originY: 'center' }); const text = new fabric.Text("è¬›æ¡Œ", { fontSize: 16, fill: '#fff', originX: 'center', originY: 'center' }); const group = new fabric.Group([rect, text], { left: canvas.width/2, top: 520, selectable: true, originX: 'center', originY: 'center' }); group.isTeacherDesk = true; canvas.add(group); }
    function addDoor() { const rect = new fabric.Rect({ width: 60, height: 10, fill: '#8D6E63', stroke: '#5D4037', strokeWidth: 1, originX: 'center', originY: 'center' }); const doorLeaf = new fabric.Rect({ width: 60, height: 40, fill: 'rgba(141, 110, 99, 0.3)', stroke: '#8D6E63', strokeDashArray:[5,5], strokeWidth: 1, top: 25, originX: 'center', originY: 'center' }); const text = new fabric.Text("é–€", { fontSize: 14, fill: '#3E2723', top: -15, originX: 'center', originY: 'center' }); const group = new fabric.Group([rect, doorLeaf, text], { left: 50, top: 50, selectable: true, originX: 'center', originY: 'center' }); canvas.add(group); }
    function addCustomObject() { const rect = new fabric.Rect({ width: 80, height: 40, fill: '#E0E0E0', stroke: '#9E9E9E', rx:5, ry:5, originX: 'center', originY: 'center' }); const text = new fabric.IText("ç‰©é«”", { fontSize: 14, fill: '#333', originX: 'center', originY: 'center' }); const group = new fabric.Group([rect, text], { left: 100, top: 100, selectable: true, originX: 'center', originY: 'center' }); canvas.add(group); }
    function removeObjectsByType(prop) { const objs = canvas.getObjects().filter(o => o[prop]); objs.forEach(o => canvas.remove(o)); }
    
    function rotateCanvas() {
        const cx = canvas.width / 2, cy = canvas.height / 2;
        canvas.getObjects().forEach(obj => {
            const newLeft = 2 * cx - obj.left;
            const newTop = 2 * cy - obj.top;
            obj.animate({ left: newLeft, top: newTop }, { duration: 500, onChange: canvas.renderAll.bind(canvas), easing: fabric.util.ease.easeInOutQuad });
        });
    }

    // --- 2. è³‡æ–™æ•´åˆ ---
    function setActiveInput(el, type, index) {
        document.querySelectorAll('.active-target').forEach(e => e.classList.remove('active-target'));
        activeInput = { element: el, type: type, index: index };
        el.classList.add('active-target');
        
        if(type === 'cadre') document.getElementById('mask-cadre').classList.add('hidden');
        else if(type === 'cleaning') document.getElementById('mask-cleaning').classList.add('hidden');
        
        refreshSidebars(); 
    }

    function addStudentToInput(displayStr) {
        if (!activeInput) return;
        saveState(activeInput.type === 'cadre' ? 'cadres' : 'cleaning');
        
        let currentValue = activeInput.element.value;
        let newValue = currentValue ? `${currentValue}, ${displayStr}` : displayStr;
        activeInput.element.value = newValue;

        if (activeInput.type === 'cadre') cadreData[activeInput.index].student = newValue;
        else if (activeInput.type === 'cleaning') cleaningTasks[activeInput.index].students = newValue;
        
        refreshSidebars();
    }

    function removeLastPerson(type, index) {
        saveState(type === 'cadre' ? 'cadres' : 'cleaning');
        let targetStr = type === 'cadre' ? cadreData[index].student : cleaningTasks[index].students;
        if(!targetStr) return;
        let arr = targetStr.split(',').map(s => s.trim());
        arr.pop();
        let newValue = arr.join(', ');
        if (type === 'cadre') { cadreData[index].student = newValue; renderCadres(); } 
        else { cleaningTasks[index].students = newValue; renderCleaningList(); }
        refreshSidebars();
    }

    function renderCadres() {
        const tbody = document.getElementById('cadreList');
        tbody.innerHTML = "";
        cadreData.forEach((item, index) => {
            tbody.innerHTML += `
                <tr>
                    <td><input type="text" class="form-control" value="${item.role}" onchange="saveState('cadres'); cadreData[${index}].role = this.value"></td>
                    <td>
                        <input type="text" class="form-control target-input" 
                               value="${item.student}" 
                               placeholder="é»æ“Šé–å®šæˆ–ç›´æ¥è¼¸å…¥"
                               onclick="setActiveInput(this, 'cadre', ${index})"
                               oninput="cadreData[${index}].student = this.value; refreshSidebars();"
                               onchange="saveState('cadres');">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger mb-1" onclick="removeLastPerson('cadre', ${index})">ğŸ‘¤ åˆªé™¤1äºº</button>
                        <button class="btn btn-sm btn-danger" onclick="saveState('cadres'); cadreData.splice(${index}, 1); renderCadres();">åˆªé™¤æ•´åˆ—</button>
                    </td>
                </tr>`;
        });
    }
    function addCadreRow() { saveState('cadres'); cadreData.push({ role: "", student: "" }); renderCadres(); }

    function renderCleaningList() {
        const tbody = document.getElementById('cleaningList');
        tbody.innerHTML = "";
        cleaningTasks.forEach((task, index) => {
            tbody.innerHTML += `
                <tr>
                    <td><input type="text" class="form-control" value="${task.name}" onchange="saveState('cleaning'); cleaningTasks[${index}].name = this.value"></td>
                    <td><input type="number" class="form-control" value="${task.count}" style="width:70px" onchange="saveState('cleaning'); cleaningTasks[${index}].count = this.value"></td>
                    <td>
                        <input type="text" class="form-control target-input" 
                               value="${task.students}" 
                               placeholder="é»æ“Šé–å®šæˆ–ç›´æ¥è¼¸å…¥"
                               onclick="setActiveInput(this, 'cleaning', ${index})"
                               oninput="cleaningTasks[${index}].students = this.value; refreshSidebars();"
                               onchange="saveState('cleaning');">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger mb-1" onclick="removeLastPerson('cleaning', ${index})">ğŸ‘¤ åˆªé™¤1äºº</button>
                        <button class="btn btn-sm btn-danger" onclick="saveState('cleaning'); cleaningTasks.splice(${index}, 1); renderCleaningList();">åˆªé™¤æ•´åˆ—</button>
                    </td>
                </tr>`;
        });
    }
    function addCleaningTask() { saveState('cleaning'); cleaningTasks.push({ name: "", count: 1, students: "" }); renderCleaningList(); }

    // --- 3. å´é‚Šæ¬„ ---
    function refreshSidebars() {
        refreshDragSidebar();
        refreshPickerSidebar('picker-cadre', 'cadre');
        refreshPickerSidebar('picker-cleaning', 'cleaning');
    }

    function refreshDragSidebar() {
        const container = document.getElementById('student-list-container');
        container.innerHTML = "";
        const keys = Object.keys(studentMap).sort((a,b) => parseInt(a) - parseInt(b));
        if(keys.length === 0) { container.innerHTML = `<div class="text-muted text-center small mt-3">è«‹åŒ¯å…¥æˆ–æ‰‹å‹•è¼¸å…¥</div>`; return; }

        let hasUnassigned = false;
        keys.forEach(key => {
            if (!placedStudentIds.has(key)) {
                hasUnassigned = true;
                let name = studentMap[key];
                let display = parseInt(key) >= 1000 ? name : (parseInt(key) < 10 ? `0${key} ${name}` : `${key} ${name}`);
                
                let div = document.createElement('div');
                div.className = 'student-tag student-draggable';
                div.draggable = true;
                div.innerText = display;
                div.dataset.id = key;
                div.ondragstart = function(ev) { ev.dataTransfer.setData("text", ev.target.innerText); ev.dataTransfer.setData("id", ev.target.dataset.id); };
                container.appendChild(div);
            }
        });
        if(!hasUnassigned) container.innerHTML = `<div class="text-success text-center mt-3">ğŸ‰ å…¨å“¡å·²å°±åº§</div>`;
    }

    function isStudentUsed(displayStr, context) {
        // V10 Fix: ç²¾ç¢ºæª¢æŸ¥ï¼Œé¿å…å­—ä¸²éƒ¨åˆ†åŒ¹é…å•é¡Œ
        let usedList = [];
        if (context === 'cadre') {
            cadreData.forEach(c => {
                if(c.student) usedList.push(...c.student.split(',').map(s=>s.trim()));
            });
        } else if (context === 'cleaning') {
            cleaningTasks.forEach(t => {
                if(t.students) usedList.push(...t.students.split(',').map(s=>s.trim()));
            });
        }
        return usedList.includes(displayStr);
    }

    function refreshPickerSidebar(containerId, context) {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = "";
        
        const keys = Object.keys(studentMap).sort((a,b) => parseInt(a) - parseInt(b));
        if(keys.length === 0) { container.innerHTML = `<div class="text-muted text-center small mt-3">ç„¡åå–®è³‡æ–™</div>`; return; }

        keys.forEach(key => {
            let name = studentMap[key];
            let display = parseInt(key) >= 1000 ? name : (parseInt(key) < 10 ? `0${key} ${name}` : `${key} ${name}`);
            
            let div = document.createElement('div');
            let usedClass = isStudentUsed(display, context) ? 'used' : '';
            div.className = `student-tag ${usedClass}`;
            div.innerText = display;
            
            div.onclick = function() { addStudentToInput(display); };
            container.appendChild(div);
        });
    }

    // --- 4. åŒ¯å…¥åŒ¯å‡º ---
    function addManualStudent() {
        const input = document.getElementById('manualNameInput');
        const name = input.value.trim();
        if(!name) return;
        const id = (manualCounter++).toString();
        studentMap[id] = name;
        input.value = '';
        refreshSidebars();
    }

    function drop(ev) {
        saveState('seats');
        ev.preventDefault();
        const studentId = ev.dataTransfer.getData("id"); 
        const pointer = canvas.getPointer(ev);
        let targetObj = null;
        
        canvas.getObjects().forEach(obj => { if(obj.containsPoint(pointer)) targetObj = obj; });
        
        if (targetObj && targetObj.isStudent) {
            if(targetObj.studentId) placedStudentIds.delete(targetObj.studentId);
            targetObj.studentId = studentId; updateSeatText(targetObj, studentId); placedStudentIds.add(studentId);
        } else {
             let slot = getClosestGridSlot(pointer.x, pointer.y);
             if(slot) {
                 let occupied = null; canvas.getObjects().forEach(o => { 
                     if(o.isStudent && !o.isFreeSeat && isAtPosition(o, slot.x, slot.y)) occupied = o; 
                 });
                 if(occupied) {
                     if(occupied.studentId) placedStudentIds.delete(occupied.studentId);
                     occupied.studentId = studentId; updateSeatText(occupied, studentId); placedStudentIds.add(studentId);
                 } else {
                     let desk = createStudentDesk(studentId, slot.x, slot.y);
                     updateSeatText(desk, studentId); placedStudentIds.add(studentId); canvas.add(desk);
                 }
             }
        }
        canvas.renderAll(); refreshSidebars();
    }
    
    function updateSeatText(groupObj, id) {
        const textObj = groupObj.getObjects()[1];
        let name = studentMap[id] || "";
        let display = parseInt(id) >= 1000 ? name : (parseInt(id) < 10 ? `0${id}` : `${id}`);
        if(name && parseInt(id) < 1000) display += `\n${name}`;
        textObj.set('text', display); groupObj.addWithUpdate();
    }
    
    function deleteSelected() {
        saveState('seats');
        const activeObj = canvas.getActiveObject();
        if(activeObj) {
            if(activeObj.type === 'activeSelection') activeObj.forEachObject(obj => { if(obj.studentId) placedStudentIds.delete(obj.studentId); });
            else if(activeObj.studentId) placedStudentIds.delete(activeObj.studentId);
            canvas.remove(activeObj); canvas.discardActiveObject(); canvas.renderAll(); refreshSidebars();
        }
    }

    function importStudentExcel(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                initGridSystem(); 
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                studentMap = {}; placedStudentIds.clear(); 
                jsonData.forEach(row => {
                    let num = row["åº§è™Ÿ"] || row["Number"];
                    let name = row["å§“å"] || row["Name"];
                    if(num && name) studentMap[num.toString()] = name;
                });
                refreshSidebars();
                alert(`åŒ¯å…¥å®Œæˆï¼`);
            } catch(err) { alert("è®€å–å¤±æ•—"); }
        };
        reader.readAsArrayBuffer(file); input.value = '';
    }
    
    function downloadExampleExcel() {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([["åº§è™Ÿ", "å§“å"], [1, "ç‹å°æ˜"], [2, "é™³å¤§å±±"]]);
        XLSX.utils.book_append_sheet(wb, ws, "åå–®"); XLSX.writeFile(wb, "ç¯„ä¾‹.xlsx");
    }

    function exportToWord() {
        // æš«æ™‚éš±è—æ ¼ç·š
        canvas.getObjects().forEach(o => { if(o.isGridLine) o.set('opacity', 0); });
        canvas.renderAll();
        
        const imgData = canvas.toDataURL({ format: 'jpeg', quality: 0.9, backgroundColor: '#FFFFFF' });
        
        // æ¢å¾©æ ¼ç·š
        canvas.getObjects().forEach(o => { if(o.isGridLine) o.set('opacity', 1); });
        canvas.renderAll();
        
        let cadreHtml = '<table border="1" style="border-collapse:collapse; width:100%; text-align:center;"><tr><th style="background:#FFE082">è·ç¨±</th><th style="background:#FFE082">è² è²¬å­¸ç”Ÿ</th></tr>';
        cadreData.forEach(c => { cadreHtml += `<tr><td>${c.role}</td><td>${c.student}</td></tr>`; });
        cadreHtml += '</table>';

        let cleaningHtml = '<table border="1" style="border-collapse:collapse; width:100%; text-align:center;"><tr><th style="background:#FFE082">å·¥ä½œé …ç›®</th><th style="background:#FFE082">äººæ•¸</th><th style="background:#FFE082">è² è²¬å­¸ç”Ÿ</th></tr>';
        cleaningTasks.forEach(t => { cleaningHtml += `<tr><td>${t.name}</td><td>${t.count}</td><td>${t.students}</td></tr>`; });
        cleaningHtml += '</table>';

        const html = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
            <head><meta charset='utf-8'></head>
            <body style="font-family: 'Microsoft JhengHei', sans-serif;">
                <h2 style="color:#E65100">ç­ç´šåº§ä½è¡¨</h2>
                <img src="${imgData}" width="600"><br><br>
                <h2 style="color:#E65100">ç­ç´šå¹¹éƒ¨åå–®</h2>
                ${cadreHtml}
                <br>
                <h2 style="color:#E65100">æƒåœ°å·¥ä½œåˆ†é…</h2>
                ${cleaningHtml}
            </body>
            </html>`;
        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ç­ç´šè³‡æ–™.doc'; a.click();
    }

    function exportToExcel() {
        const wb = XLSX.utils.book_new();
        let seatRows = [["--- åº§ä½è¡¨é…ç½® (åƒ…ä¾›åƒè€ƒ) ---"]];
        let students = canvas.getObjects().filter(o => o.isStudent).sort((a,b) => (a.top - b.top) || (a.left - b.left));
        students.forEach(s => { let text = s.getObjects()[1].text.replace('\n', ' '); seatRows.push([text]); });
        const wsSeats = XLSX.utils.aoa_to_sheet(seatRows);
        XLSX.utils.book_append_sheet(wb, wsSeats, "åº§ä½è¡¨æ–‡å­—ç‰ˆ");

        const wsCadres = XLSX.utils.json_to_sheet(cadreData.map(c => ({ "è·ç¨±": c.role, "è² è²¬å­¸ç”Ÿ": c.student })));
        XLSX.utils.book_append_sheet(wb, wsCadres, "å¹¹éƒ¨åå–®");

        const wsCleaning = XLSX.utils.json_to_sheet(cleaningTasks.map(t => ({ "å·¥ä½œé …ç›®": t.name, "äººæ•¸": t.count, "è² è²¬å­¸ç”Ÿ": t.students })));
        XLSX.utils.book_append_sheet(wb, wsCleaning, "æƒå€åå–®");

        XLSX.writeFile(wb, "ç­ç´šç¶“ç‡Ÿè³‡æ–™.xlsx");
    }

    function allowDrop(ev) { ev.preventDefault(); }
    
    document.querySelectorAll('.nav-link').forEach(btn => {
        btn.addEventListener('click', e => {
            document.querySelectorAll('.nav-link, .tab-pane').forEach(el => el.classList.remove('active', 'show'));
            e.target.classList.add('active');
            document.querySelector(e.target.getAttribute('data-bs-target')).classList.add('active', 'show');
        });
    });

    window.onload = function() { initGridSystem(); renderCadres(); renderCleaningList(); switchTab('seats'); }
</script>

</body>
</html>