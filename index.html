<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šç¶“ç‡ŸåŠ©æ‰‹ V.14.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root { --bg-color: #FFF8E1; --primary-color: #FFAB40; --text-color: #5D4037; }
        body { 
            padding: 20px; background-color: var(--bg-color);
            background-image: radial-gradient(#FFD54F 2px, transparent 2px);
            background-size: 30px 30px;
            font-family: "Microsoft JhengHei", sans-serif; 
            color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }
        .main-container { 
            background-color: #fff; padding: 20px; border-radius: 25px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); border: 3px solid #FFE082; 
            flex: 1; display: flex; flex-direction: column;
        }
        .btn { border-radius: 50px; font-weight: bold; margin-bottom: 5px; }
        .btn-purple { background-color: #AB47BC; color: white; }
        
        .canvas-area {
            position: relative; border: 4px dashed #FFB74D; border-radius: 15px;
            background-color: #FFF; margin: 0 auto; display: inline-block;
        }
        
        .student-sidebar {
            background: #E1F5FE; border: 2px solid #81D4FA; border-radius: 15px; padding: 10px;
            height: 100%; overflow-y: auto; display: flex; flex-direction: column; position: relative;
        }
        .student-list-content { flex: 1; overflow-y: auto; margin-top: 10px; }
        
        .sidebar-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 10;
            display: flex; justify-content: center; align-items: center;
            border-radius: 13px; text-align: center; color: #78909C; font-weight: bold;
            backdrop-filter: blur(2px); cursor: not-allowed;
        }
        .sidebar-mask.hidden { display: none; }

        .student-tag {
            background: #FFF; border: 1px solid #039BE5; padding: 8px; margin-bottom: 5px; border-radius: 8px;
            cursor: pointer; font-weight: bold; color: #0277BD; transition: all 0.2s; text-align: center; user-select: none;
        }
        .student-tag:hover { background: #81D4FA; color: white; transform: translateX(5px); }
        .student-tag:active { transform: scale(0.95); }
        .student-tag.used { background-color: #ECEFF1; color: #90A4AE; border-color: #CFD8DC; }
        .student-tag.used:hover { background-color: #B0BEC5; color: white; }
        .student-draggable { cursor: grab; }
        
        .footer { margin-top: auto; text-align: center; color: #8D6E63; padding-top: 20px; border-top: 2px dashed #FFCC80; }
        .footer a { background-color: #FF7043; color: white; padding: 5px 15px; border-radius: 20px; text-decoration: none; }
        
        .manual-input-group { background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
        .table-custom th { background-color: #FFE082; color: #5D4037; text-align: center; }
        .tab-pane { height: 100%; overflow-y: auto; }
        
        input.target-input:focus { border: 2px solid #FFAB40; background-color: #FFF8E1; box-shadow: 0 0 8px rgba(255, 171, 64, 0.5); }
        input.active-target { border: 2px solid #FF5722 !important; background-color: #FFCCBC !important; }
        .undo-bar { margin-bottom: 10px; text-align: right; }

        .color-palette { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; justify-content: center; }
        .color-btn { width: 30px; height: 30px; border-radius: 5px; border: 1px solid #999; cursor: pointer; transition: transform 0.2s; }
        .color-btn:hover { transform: scale(1.2); z-index: 10; border-color: #000; }

        .slider-control { background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 10px; }
        .slider-label { font-size: 0.8rem; font-weight: bold; color: #666; display: flex; justify-content: space-between; }
        
        .d-pad { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; width: 100px; margin: 0 auto; }
        .d-pad button { padding: 2px 0; font-size: 1.2rem; }

        .batch-paste-area { margin-top: 10px; display: none; background: #fff; padding: 10px; border: 1px dashed #039BE5; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container-fluid main-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="m-0" style="color:#E65100;">ğŸ« ç­ç´šç¶“ç‡ŸåŠ©æ‰‹ <small class="fs-6 text-muted">V.14.1</small></h3>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-dark" onclick="downloadConfig()">ğŸ’¾ ä¸‹è¼‰è¨­å®š</button>
            <button class="btn btn-sm btn-warning" onclick="document.getElementById('configInput').click()">ğŸ“‚ è®€å–è¨­å®š</button>
            <input type="file" id="configInput" accept=".json" style="display: none;" onchange="loadConfig(this)">
            <div class="vr mx-2"></div>
            <input type="file" id="excelInput" accept=".xlsx, .xls" style="display: none;" onchange="importStudentExcel(this)">
            <button class="btn btn-sm btn-purple" onclick="downloadExampleExcel()">ğŸ“¥ ç¯„ä¾‹</button>
            <button class="btn btn-sm btn-purple" onclick="document.getElementById('excelInput').click()">ğŸ“¤ åŒ¯å…¥</button>
            <div class="vr mx-2"></div>
            <button class="btn btn-sm btn-outline-primary" onclick="exportToWord()">ğŸ“ Word</button>
            <button class="btn btn-sm btn-outline-success" onclick="exportToExcel()">ğŸ“Š Excel</button>
        </div>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" id="seats-tab" data-bs-toggle="tab" data-bs-target="#seats-panel" type="button" onclick="switchTab('seats')">1. ğŸª‘ æ’åº§ä½</button></li>
        <li class="nav-item"><button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups-panel" type="button" onclick="switchTab('groups')">4. ğŸ‘¥ åˆ†çµ„åº§ä½</button></li>
        <li class="nav-item"><button class="nav-link" id="cadres-tab" data-bs-toggle="tab" data-bs-target="#cadres-panel" type="button" onclick="switchTab('cadres')">2. ğŸ–ï¸ æ’å¹¹éƒ¨</button></li>
        <li class="nav-item"><button class="nav-link" id="cleaning-tab" data-bs-toggle="tab" data-bs-target="#cleaning-panel" type="button" onclick="switchTab('cleaning')">3. ğŸ§¹ å®‰æ’æƒå€</button></li>
    </ul>

    <div class="tab-content p-3 bg-white border-top-0 flex-grow-1" id="myTabContent">
        
        <div class="tab-pane fade show active" id="seats-panel" role="tabpanel">
            <div class="undo-bar"><button class="btn btn-sm btn-outline-secondary" onclick="undo('seats')">â†©ï¸ ä¸Šä¸€æ­¥</button></div>
            <div class="row h-100">
                <div class="col-md-2">
                    <div class="p-3 bg-light rounded border h-100 overflow-auto">
                        <h6 class="fw-bold">ğŸ“ é…ç½®</h6>
                        <div class="row g-1 mb-2">
                            <div class="col-6"><label>ç›´æ’</label><input type="number" id="inputRowsMain" class="form-control form-control-sm" value="5"></div>
                            <div class="col-6"><label>æ©«åˆ—</label><input type="number" id="inputColsMain" class="form-control form-control-sm" value="6"></div>
                        </div>
                        <button class="btn btn-primary btn-sm w-100 mb-2" onclick="initGridSystem('main')">âœ¨ ç”Ÿæˆåº§ä½</button>
                        
                        <div class="slider-control">
                            <div class="slider-label"><span>å¤§å°</span><span id="sizeValMain">90</span></div>
                            <input type="range" class="form-range" min="50" max="150" value="90" oninput="updateGridSettings('main', 'size', this.value)">
                            <div class="slider-label"><span>â†”ï¸ é–“è·</span><span id="gapXValMain">110</span></div>
                            <input type="range" class="form-range" min="60" max="200" value="110" oninput="updateGridSettings('main', 'gapX', this.value)">
                            <div class="slider-label"><span>â†•ï¸ é–“è·</span><span id="gapYValMain">80</span></div>
                            <input type="range" class="form-range" min="40" max="200" value="80" oninput="updateGridSettings('main', 'gapY', this.value)">
                        </div>

                        <div class="mb-2 text-center">
                            <small class="text-muted">å…¨é«”ç§»å‹•</small>
                            <div class="d-pad">
                                <div></div><button class="btn btn-sm btn-outline-secondary" onclick="shiftCanvas('main', 0, -20)">â¬†ï¸</button><div></div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="shiftCanvas('main', -20, 0)">â¬…ï¸</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="shiftCanvas('main', 0, 20)">â¬‡ï¸</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="shiftCanvas('main', 20, 0)">â¡ï¸</button>
                            </div>
                        </div>

                        <hr>
                        <h6 class="fw-bold">ğŸ› ï¸ å·¥å…·</h6>
                        <button class="btn btn-secondary btn-sm w-100" onclick="addTeacherDesk('main')">ğŸ‘©â€ğŸ« è¬›æ¡Œ</button>
                        <button class="btn btn-dark btn-sm w-100" onclick="addBlackboard('main')">ğŸ« é»‘æ¿</button>
                        <button class="btn btn-warning btn-sm w-100 text-dark" onclick="addDoor('main')">ğŸšª é–€</button>
                        <button class="btn btn-outline-primary btn-sm w-100 mt-1 fw-bold" style="border-style:dashed;" onclick="addFreeSeat('main')">âœ¨ è‡ªç”±åº§</button>
                        <button class="btn btn-info btn-sm w-100 text-white mt-1" onclick="addCustomObject('main')">ğŸ“¦ å¯å‘½åç‰©é«”</button>
                        <button class="btn btn-danger btn-sm w-100 mt-2" onclick="deleteSelected('main')">ğŸ—‘ï¸ åˆªé™¤é¸å–</button>
                        <button class="btn btn-outline-danger btn-sm w-100 mt-1" onclick="clearAllSeats('main')">â™»ï¸ å…¨éƒ¨æ¸…ç©º</button>
                        <button class="btn btn-outline-dark btn-sm w-100 mt-1" onclick="rotateCanvas('main')">ğŸ”„ è¦–è§’åˆ‡æ›</button>
                    </div>
                </div>
                <div class="col-md-8 text-center">
                    <div class="canvas-area" id="canvas-container-main" ondrop="drop(event, 'main')" ondragover="allowDrop(event)">
                        <canvas id="c" width="800" height="600"></canvas>
                    </div>
                </div>
                <div class="col-md-2" style="height: 600px;">
                    <div class="student-sidebar">
                        <h6 class="fw-bold text-center border-bottom pb-2">ğŸ“‹ å­¸ç”Ÿåå–®</h6>
                        <div class="manual-input-group mb-2">
                            <input type="text" id="manualNameInput" class="form-control form-control-sm mb-1" placeholder="è¼¸å…¥å§“å">
                            <button class="btn btn-success btn-sm w-100 mb-1" onclick="addManualStudent()">â• åŠ å…¥</button>
                            <button class="btn btn-primary btn-sm w-100 mb-1" onclick="autoSeatStudents('main')">âš¡ è‡ªå‹•å…¥åº§</button>
                            <button class="btn btn-info btn-sm w-100 text-white mb-1" onclick="randomizeSeats('main')">ğŸ² éš¨æ©Ÿåˆ†é…</button>
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="toggleBatchPaste()">ğŸ“‹ æ‰¹æ¬¡è²¼ä¸Š</button>
                            
                            <div id="batchPasteArea" class="batch-paste-area">
                                <small class="text-muted d-block mb-1">ä¸€è¡Œä¸€ä½ (åº§è™Ÿ+å§“å æˆ– åƒ…å§“å)</small>
                                <textarea id="batchInput" class="form-control form-control-sm mb-2" rows="5" placeholder="ä¾‹å¦‚ï¼š
01 ç‹å°æ˜
02 æå¤§åŒ
é™³å°ç¾"></textarea>
                                <button class="btn btn-sm btn-primary w-100" onclick="processBatchPaste()">ç¢ºèªåŒ¯å…¥</button>
                            </div>
                        </div>
                        <div id="student-list-container" class="student-list-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="groups-panel" role="tabpanel">
            <div class="undo-bar"><button class="btn btn-sm btn-outline-secondary" onclick="undo('groups')">â†©ï¸ ä¸Šä¸€æ­¥</button></div>
            <div class="row h-100">
                <div class="col-md-2">
                    <div class="p-3 bg-light rounded border h-100 overflow-auto">
                        <h6 class="fw-bold">ğŸ“ åˆ†çµ„é…ç½®</h6>
                        <div class="row g-1 mb-2">
                            <div class="col-6"><label>ç›´æ’</label><input type="number" id="inputRowsGroup" class="form-control form-control-sm" value="6"></div>
                            <div class="col-6"><label>æ©«åˆ—</label><input type="number" id="inputColsGroup" class="form-control form-control-sm" value="6"></div>
                        </div>
                        <button class="btn btn-primary btn-sm w-100 mb-2" onclick="initGridSystem('group')">âœ¨ ç”Ÿæˆåˆ†çµ„</button>
                        
                        <div class="slider-control">
                            <div class="slider-label"><span>å¤§å°</span><span id="sizeValGroup">90</span></div>
                            <input type="range" class="form-range" min="50" max="150" value="90" oninput="updateGridSettings('group', 'size', this.value)">
                            <div class="slider-label"><span>â†”ï¸ é–“è·</span><span id="gapXValGroup">110</span></div>
                            <input type="range" class="form-range" min="60" max="200" value="110" oninput="updateGridSettings('group', 'gapX', this.value)">
                            <div class="slider-label"><span>â†•ï¸ é–“è·</span><span id="gapYValGroup">80</span></div>
                            <input type="range" class="form-range" min="40" max="200" value="80" oninput="updateGridSettings('group', 'gapY', this.value)">
                        </div>

                        <div class="mb-2 text-center">
                            <small class="text-muted">å…¨é«”ç§»å‹•</small>
                            <div class="d-pad">
                                <div></div><button class="btn btn-sm btn-outline-secondary" onclick="shiftCanvas('group', 0, -20)">â¬†ï¸</button><div></div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="shiftCanvas('group', -20, 0)">â¬…ï¸</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="shiftCanvas('group', 0, 20)">â¬‡ï¸</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="shiftCanvas('group', 20, 0)">â¡ï¸</button>
                            </div>
                        </div>

                        <hr>
                        <h6 class="fw-bold">ğŸ¨ é»æ“Šæ›è‰²</h6>
                        <div class="color-palette" id="colorPalette"></div>

                        <hr>
                        <h6 class="fw-bold">ğŸ› ï¸ å·¥å…·</h6>
                        <button class="btn btn-secondary btn-sm w-100" onclick="addTeacherDesk('group')">ğŸ‘©â€ğŸ« è¬›æ¡Œ</button>
                        <button class="btn btn-dark btn-sm w-100" onclick="addBlackboard('group')">ğŸ« é»‘æ¿</button>
                        <button class="btn btn-warning btn-sm w-100 text-dark" onclick="addDoor('group')">ğŸšª é–€</button>
                        <button class="btn btn-outline-primary btn-sm w-100 mt-1 fw-bold" style="border-style:dashed;" onclick="addFreeSeat('group')">âœ¨ è‡ªç”±åº§</button>
                        <button class="btn btn-info btn-sm w-100 text-white mt-1" onclick="addCustomObject('group')">ğŸ“¦ å¯å‘½åç‰©é«”</button>
                        <button class="btn btn-danger btn-sm w-100 mt-2" onclick="deleteSelected('group')">ğŸ—‘ï¸ åˆªé™¤é¸å–</button>
                        <button class="btn btn-outline-danger btn-sm w-100 mt-1" onclick="clearAllSeats('group')">â™»ï¸ å…¨éƒ¨æ¸…ç©º</button>
                        <button class="btn btn-outline-dark btn-sm w-100 mt-1" onclick="rotateCanvas('group')">ğŸ”„ è¦–è§’åˆ‡æ›</button>
                    </div>
                </div>
                <div class="col-md-8 text-center">
                    <div class="canvas-area" id="canvas-container-group" ondrop="drop(event, 'group')" ondragover="allowDrop(event)">
                        <canvas id="c-group" width="800" height="600"></canvas>
                    </div>
                </div>
                <div class="col-md-2" style="height: 600px;">
                    <div class="student-sidebar">
                        <h6 class="fw-bold text-center border-bottom pb-2">ğŸ“‹ å­¸ç”Ÿåå–®</h6>
                        <button class="btn btn-primary btn-sm w-100 mb-1" onclick="autoSeatStudents('group')">âš¡ è‡ªå‹•å…¥åº§</button>
                        <button class="btn btn-info btn-sm w-100 mb-2 text-white" onclick="randomizeSeats('group')">ğŸ² éš¨æ©Ÿåˆ†é…</button>
                        <div id="student-list-container-group" class="student-list-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="cadres-panel">
            <div class="undo-bar"><button class="btn btn-sm btn-outline-secondary" onclick="undo('cadres')">â†©ï¸ ä¸Šä¸€æ­¥</button></div>
            <div class="row h-100">
                <div class="col-md-9">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="text-primary fw-bold">ğŸ–ï¸ ç­ç´šå¹¹éƒ¨åå–®</h4>
                        <button class="btn btn-success" onclick="addCadreRow()">â• å¢åŠ è·ä½</button>
                    </div>
                    <div class="alert alert-info py-2"><small>ğŸ’¡ å…ˆé»é¸å·¦å´æ¬„ä½(è®Šæ©˜è‰²)ï¼Œå†é»å³å´åå–®ã€‚äº¦å¯ç›´æ¥æ‰“å­—ã€‚</small></div>
                    <table class="table table-bordered table-hover table-custom align-middle">
                        <thead><tr><th width="30%">è·ç¨±</th><th>è² è²¬å­¸ç”Ÿ</th><th width="20%">æ“ä½œ</th></tr></thead>
                        <tbody id="cadreList"></tbody>
                    </table>
                </div>
                <div class="col-md-3">
                    <div class="student-sidebar">
                        <h6 class="fw-bold text-center border-bottom pb-2">ğŸ“‹ é»æ“Šé¸æ“‡å­¸ç”Ÿ</h6>
                        <div id="mask-cadre" class="sidebar-mask">ğŸ”’ è«‹å…ˆé»é¸<br>å·¦å´ç›®æ¨™æ¬„ä½</div>
                        <div id="picker-cadre" class="student-list-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="cleaning-panel">
            <div class="undo-bar"><button class="btn btn-sm btn-outline-secondary" onclick="undo('cleaning')">â†©ï¸ ä¸Šä¸€æ­¥</button></div>
            <div class="row h-100">
                <div class="col-md-9">
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6"><button class="btn btn-success" onclick="addCleaningTask()">â• å¢åŠ æƒå€</button></div>
                        <div class="col-md-6 text-end"><h4 class="text-success fw-bold m-0">ğŸ§¹ æƒåœ°å·¥ä½œåˆ†é…</h4></div>
                    </div>
                    <div class="alert alert-success py-2" style="--bs-alert-bg:#E8F5E9; --bs-alert-color:#2E7D32;"><small>ğŸ’¡ å…ˆé»é¸å·¦å´æ¬„ä½(è®Šæ©˜è‰²)ï¼Œå†é»å³å´åå–®ã€‚äº¦å¯ç›´æ¥æ‰“å­—ã€‚</small></div>
                    <table class="table table-bordered table-hover table-custom align-middle">
                        <thead><tr><th>å·¥ä½œé …ç›®</th><th width="15%">äººæ•¸</th><th>è² è²¬å­¸ç”Ÿ</th><th width="20%">æ“ä½œ</th></tr></thead>
                        <tbody id="cleaningList"></tbody>
                    </table>
                </div>
                <div class="col-md-3">
                    <div class="student-sidebar">
                        <h6 class="fw-bold text-center border-bottom pb-2">ğŸ“‹ é»æ“Šé¸æ“‡å­¸ç”Ÿ</h6>
                        <div id="mask-cleaning" class="sidebar-mask">ğŸ”’ è«‹å…ˆé»é¸<br>å·¦å´ç›®æ¨™æ¬„ä½</div>
                        <div id="picker-cleaning" class="student-list-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <p>2026 @ å¥•éˆè€å¸«è£½ä½œ <a href="https://www.facebook.com/share/1K5MsceXxS/?mibextid=wwXIfr" target="_blank">ğŸ‘ å¥•éˆè€å¸«çš„æ•¸ä½å‚™èª²å®¤</a></p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 0. æ ¸å¿ƒè¨­å®š ---
    (function() {
        const originalFillText = CanvasRenderingContext2D.prototype.fillText;
        CanvasRenderingContext2D.prototype.fillText = function(...args) {
            if (this.textBaseline === 'alphabetical') this.textBaseline = 'bottom';
            return originalFillText.apply(this, args);
        };
    })();
    fabric.Object.prototype.objectCaching = false;

    const canvasMain = new fabric.Canvas('c', { selection: true, backgroundColor: '#FFFFFF' });
    const canvasGroup = new fabric.Canvas('c-group', { selection: true, backgroundColor: '#FFFFFF' });
    let currentCanvas = canvasMain;
    let currentMode = 'main';

    let mainConfig = { rows: 5, cols: 6, startX: 0, startY: 0, seatW: 90, seatH: 50, gapX: 110, gapY: 80 };
    let groupConfig = { rows: 6, cols: 6, startX: 0, startY: 0, seatW: 90, seatH: 50, gapX: 110, gapY: 80 };

    let studentMap = {}; 
    let placedMain = new Set();
    let placedGroup = new Set();
    let manualCounter = 1000;
    let activeInput = null;

    const historyStack = { seats: [], groups: [], cadres: [], cleaning: [] };
    const MAX_HISTORY = 20;

    const colors = [
        '#FFAB91', '#F48FB1', '#CE93D8', '#B39DDB', '#9FA8DA', 
        '#90CAF9', '#81D4FA', '#80CBC4', '#A5D6A7', '#C5E1A5', 
        '#E6EE9C', '#FFF59D', '#FFE082', '#FFCC80', '#BCAAA4', '#FFFFFF'
    ];
    const groupInitColors = ['#FFF9C4', '#FFFFFF', '#BBDEFB', '#C8E6C9'];
    
    const palette = document.getElementById('colorPalette');
    colors.forEach(color => {
        let btn = document.createElement('div');
        btn.className = 'color-btn';
        btn.style.backgroundColor = color;
        btn.onclick = () => applyColorToSeat(color);
        palette.appendChild(btn);
    });

    function applyColorToSeat(color) {
        const activeObj = canvasGroup.getActiveObject();
        if (activeObj) {
            if(activeObj.type === 'activeSelection') {
                activeObj.forEachObject(obj => { if(obj.isStudent) obj.item(0).set('fill', color); });
            } else if(activeObj.isStudent) {
                activeObj.item(0).set('fill', color);
            }
            canvasGroup.renderAll(); saveState('groups');
        }
    }

    const defaultCadresList = ["ç­é•·", "å‰¯ç­é•·", "å­¸è—è‚¡é•·", "é¢¨ç´€è‚¡é•·", "è¡›ç”Ÿè‚¡é•·", "ç¸½å‹™è‚¡é•·", "åº·æ¨‚è‚¡é•·", "ç‰›å¥¶é•·", "æ¦®è­½é•·", "åœ‹èªå°è€å¸«", "è‹±èªå°è€å¸«", "æ•¸å­¸å°è€å¸«", "è‡ªç„¶å°è€å¸«", "ç¤¾æœƒå°è€å¸«"];
    let cadreData = defaultCadresList.map(role => ({ role: role, student: "" }));

    const defaultCleaningList = ["æ•™å®¤å…§æƒåœ°", "æ•™å®¤å…§æ‹–åœ°", "æ“¦çª—æˆ¶", "æ•´ç†é»‘æ¿", "æ•´ç†é›»è¦–é›»è…¦æ«ƒ", "ä¸€èˆ¬åƒåœ¾", "å›æ”¶åƒåœ¾", "æ´—æ‰‹å°", "é™½å°", "æ•´ç†æƒå…·", "èµ°å»Š", "å¤–æƒå€"];
    let cleaningTasks = defaultCleaningList.map(task => ({ name: task, count: 2, students: "" }));

    // --- Batch Paste Feature ---
    function toggleBatchPaste() {
        const area = document.getElementById('batchPasteArea');
        area.style.display = area.style.display === 'none' || area.style.display === '' ? 'block' : 'none';
    }

    function processBatchPaste() {
        const text = document.getElementById('batchInput').value;
        const lines = text.split('\n');
        let count = 0;
        lines.forEach(line => {
            line = line.trim();
            if(!line) return;
            const match = line.match(/^(\d+)[\s\t\.\,ã€]+(.+)$/);
            if (match) {
                studentMap[match[1]] = match[2].trim();
                count++;
            } else {
                if (!/^\d+$/.test(line)) {
                    let id = (manualCounter++).toString();
                    studentMap[id] = line;
                    count++;
                }
            }
        });
        document.getElementById('batchInput').value = '';
        toggleBatchPaste();
        refreshSidebars();
        alert(`å·²æˆåŠŸåŒ¯å…¥ ${count} ç­†è³‡æ–™`);
    }

    // --- Shift Logic ---
    function shiftCanvas(mode, dx, dy) {
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        let cfg = mode === 'main' ? mainConfig : groupConfig;
        saveState(mode === 'main' ? 'seats' : 'groups');
        cfg.startX += dx; cfg.startY += dy;
        cvs.getObjects().forEach(obj => {
            obj.left += dx; obj.top += dy;
            if (obj._startLeft !== undefined) { obj._startLeft += dx; obj._startTop += dy; }
            obj.setCoords();
        });
        const oldLines = cvs.getObjects().filter(o => o.isGridLine);
        oldLines.forEach(o => cvs.remove(o));
        drawGridLines(cvs, cfg);
        cvs.renderAll();
    }

    function switchTab(tabName) {
        activeInput = null;
        document.querySelectorAll('.active-target').forEach(e => e.classList.remove('active-target'));
        document.getElementById('mask-cadre').classList.remove('hidden');
        document.getElementById('mask-cleaning').classList.remove('hidden');
        if (tabName === 'seats') { currentCanvas = canvasMain; currentMode = 'main'; refreshSidebars(); } 
        else if (tabName === 'groups') { currentCanvas = canvasGroup; currentMode = 'group'; currentCanvas.calcOffset(); refreshSidebars(); }
    }

    function saveState(type) {
        let state;
        let props = ['studentId', 'isStudent', 'isGridLine', 'isBlackboard', 'isTeacherDesk', 'isFreeSeat', '_startLeft', '_startTop'];
        if (type === 'seats') state = JSON.stringify({ canvas: canvasMain.toJSON(props), placed: Array.from(placedMain), config: mainConfig });
        else if (type === 'groups') state = JSON.stringify({ canvas: canvasGroup.toJSON(props), placed: Array.from(placedGroup), config: groupConfig });
        else if (type === 'cadres') state = JSON.stringify(cadreData);
        else if (type === 'cleaning') state = JSON.stringify(cleaningTasks);
        historyStack[type].push(state);
        if(historyStack[type].length > MAX_HISTORY) historyStack[type].shift();
    }

    function undo(type) {
        if(historyStack[type].length === 0) { alert("ç„¡æ›´æ—©ç´€éŒ„"); return; }
        const state = JSON.parse(historyStack[type].pop());
        if(type === 'seats') {
            mainConfig = state.config || mainConfig;
            canvasMain.loadFromJSON(state.canvas, () => { placedMain = new Set(state.placed); canvasMain.renderAll(); refreshSidebars(); });
        } else if (type === 'groups') {
            groupConfig = state.config || groupConfig;
            canvasGroup.loadFromJSON(state.canvas, () => { placedGroup = new Set(state.placed); canvasGroup.renderAll(); refreshSidebars(); });
        } else if(type === 'cadres') { cadreData = state; renderCadres(); }
        else if(type === 'cleaning') { cleaningTasks = state; renderCleaningList(); }
    }

    [canvasMain, canvasGroup].forEach((c, idx) => {
        let type = idx === 0 ? 'seats' : 'groups';
        c.on('object:modified', () => saveState(type));
        c.on('object:added', (e) => { if(!e.target.isGridLine) saveState(type); });
        
        c.on('mouse:down', (opt) => {
            if(opt.target) {
                opt.target._startLeft = opt.target.left;
                opt.target._startTop = opt.target.top;
            }
        });

        c.on('object:modified', (opt) => {
            const target = opt.target;
            if (!target || !target.isStudent) return; 

            let cfg = (c === canvasMain) ? mainConfig : groupConfig;
            let closestSlot = null;
            let isGridTarget = !target.isFreeSeat;

            if (isGridTarget) {
                closestSlot = getClosestGridSlot(target.left, target.top, cfg);
                if (!closestSlot) {
                    animateMove(target, target._startLeft, target._startTop, c);
                    return;
                }
            }

            // ç¢°æ’æª¢æ¸¬ - V13 ä¿®å¾©ï¼šè‡ªç”±åº§ä¹Ÿèƒ½æ­£ç¢ºç¢°æ’
            let occupiedObj = null;
            c.getObjects().forEach(obj => {
                if (obj === target) return;
                if (!obj.isStudent) return;

                let isCollision = false;
                if (isGridTarget) {
                    isCollision = isAtPosition(obj, closestSlot.x, closestSlot.y);
                } else {
                    let dist = Math.sqrt(Math.pow(obj.left - target.left, 2) + Math.pow(obj.top - target.top, 2));
                    isCollision = dist < 40; 
                }
                if (isCollision) occupiedObj = obj;
            });

            if (occupiedObj) {
                // äº¤æ›
                animateMove(occupiedObj, target._startLeft, target._startTop, c);
                occupiedObj._startLeft = target._startLeft;
                occupiedObj._startTop = target._startTop;
                
                if (isGridTarget) target.set({ left: closestSlot.x, top: closestSlot.y });
                // è‹¥æ˜¯è‡ªç”±åº§ï¼Œåœåœ¨åŸåœ°å³å¯
                target.setCoords();
            } else {
                if (isGridTarget) target.set({ left: closestSlot.x, top: closestSlot.y });
                target.setCoords();
            }
            c.renderAll();
        });
    });

    function isAtPosition(obj, x, y) { return Math.abs(obj.left - x) < 20 && Math.abs(obj.top - y) < 20; }
    function getClosestGridSlot(x, y, cfg) {
        let col = Math.round((x - cfg.startX) / cfg.gapX);
        let row = Math.round((y - cfg.startY) / cfg.gapY);
        if (col < 0 || col >= cfg.cols || row < 0 || row >= cfg.rows) return null;
        return { x: cfg.startX + col * cfg.gapX, y: cfg.startY + row * cfg.gapY };
    }
    function animateMove(obj, left, top, c) {
        obj.animate({ left: left, top: top }, { duration: 200, onChange: c.renderAll.bind(c), easing: fabric.util.ease.easeOutQuad });
    }

    function updateGridSettings(mode, type, val) {
        val = parseInt(val);
        let cfg = (mode === 'main') ? mainConfig : groupConfig;
        if (mode === 'main') {
            if(type==='size') document.getElementById('sizeValMain').innerText = val;
            if(type==='gapX') document.getElementById('gapXValMain').innerText = val;
            if(type==='gapY') document.getElementById('gapYValMain').innerText = val;
        } else {
            if(type==='size') document.getElementById('sizeValGroup').innerText = val;
            if(type==='gapX') document.getElementById('gapXValGroup').innerText = val;
            if(type==='gapY') document.getElementById('gapYValGroup').innerText = val;
        }

        if (type === 'size') { cfg.seatW = val; cfg.seatH = val * 0.6; }
        else if (type === 'gapX') { cfg.gapX = val; }
        else if (type === 'gapY') { cfg.gapY = val; }

        initGridSystem(mode);
    }

    function initGridSystem(mode) {
        let cvs = (mode === 'main') ? canvasMain : canvasGroup;
        let cfg = (mode === 'main') ? mainConfig : groupConfig;
        let placedSet = (mode === 'main') ? placedMain : placedGroup;
        
        saveState(mode === 'main' ? 'seats' : 'groups');
        cvs.clear();
        cvs.setBackgroundColor('#FFFFFF', cvs.renderAll.bind(cvs));
        placedSet.clear();

        if (mode === 'main') {
            cfg.rows = parseInt(document.getElementById('inputRowsMain').value) || 5;
            cfg.cols = parseInt(document.getElementById('inputColsMain').value) || 6;
        } else {
            cfg.rows = parseInt(document.getElementById('inputRowsGroup').value) || 6;
            cfg.cols = parseInt(document.getElementById('inputColsGroup').value) || 6;
        }
        
        const totalWidth = (cfg.cols - 1) * cfg.gapX + cfg.seatW;
        cfg.startX = (cvs.width - totalWidth) / 2 + (cfg.seatW/2);
        cfg.startY = 100 + (cfg.seatH/2);

        drawGridLines(cvs, cfg);

        let counter = 1;
        for(let r=0; r<cfg.rows; r++) {
            for(let c=0; c<cfg.cols; c++) {
                let id = counter.toString();
                let x = cfg.startX + c * cfg.gapX;
                let y = cfg.startY + r * cfg.gapY;
                
                if (mode === 'group') {
                    if (counter <= 25) {
                        let color = groupInitColors[Math.floor((counter-1)/5) % 4]; 
                        let desk = createStudentDesk(id, x, y, cfg.seatW, cfg.seatH, color);
                        cvs.add(desk);
                        if(studentMap[id]) { updateSeatText(desk, id); placedSet.add(id); }
                    }
                } else {
                    let desk = createStudentDesk(id, x, y, cfg.seatW, cfg.seatH, '#FFECB3');
                    cvs.add(desk);
                    if(studentMap[id]) { updateSeatText(desk, id); placedSet.add(id); }
                }
                counter++;
            }
        }
        addBlackboard(mode); addTeacherDesk(mode);
        refreshSidebars();
    }

    function drawGridLines(cvs, cfg) {
        const oldLines = cvs.getObjects().filter(o => o.isGridLine);
        oldLines.forEach(o => cvs.remove(o));
        for(let r=0; r<cfg.rows; r++) {
            for(let c=0; c<cfg.cols; c++) {
                let x = cfg.startX + c * cfg.gapX;
                let y = cfg.startY + r * cfg.gapY;
                const rect = new fabric.Rect({ 
                    left: x, top: y, width: cfg.seatW + 10, height: cfg.seatH + 10, 
                    fill: 'transparent', stroke: '#E0E0E0', strokeWidth: 1, strokeDashArray: [5, 5], 
                    originX: 'center', originY: 'center', selectable: false, evented: false 
                });
                rect.isGridLine = true;
                cvs.add(rect);
                cvs.sendToBack(rect);
            }
        }
    }

    function createStudentDesk(id, x, y, w, h, color) {
        const desk = new fabric.Rect({ width: w, height: h, fill: color, stroke: '#FFB74D', strokeWidth: 2, rx: 10, ry: 10, originX: 'center', originY: 'center' });
        const text = new fabric.IText(id, { fontSize: w * 0.2, fill: '#5D4037', fontFamily: 'Microsoft JhengHei', fontWeight: 'bold', originX: 'center', originY: 'center', textAlign: 'center' });
        const group = new fabric.Group([desk, text], { left: x, top: y, selectable: true, hasControls: false, originX: 'center', originY: 'center' });
        group.isStudent = true; group.studentId = id; 
        return group;
    }

    function addTeacherDesk(mode) { 
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        let objs = cvs.getObjects().filter(o => o.isTeacherDesk); objs.forEach(o => cvs.remove(o));
        const rect = new fabric.Rect({ width: 100, height: 50, fill: '#A1887F', stroke: '#5D4037', strokeWidth: 2, originX: 'center', originY: 'center' });
        const text = new fabric.Text("è¬›æ¡Œ", { fontSize: 16, fill: '#fff', originX: 'center', originY: 'center' });
        const group = new fabric.Group([rect, text], { left: cvs.width/2, top: 520, selectable: true, originX: 'center', originY: 'center' }); 
        group.isTeacherDesk = true; cvs.add(group); 
    }
    function addBlackboard(mode) {
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        let objs = cvs.getObjects().filter(o => o.isBlackboard); objs.forEach(o => cvs.remove(o));
        const rect = new fabric.Rect({ width: 500, height: 25, fill: '#2F4F2F', stroke: '#5D4037', strokeWidth: 3, rx:5, ry:5, originX: 'center', originY: 'center' });
        const text = new fabric.Text("é»‘æ¿", { fontSize: 16, fill: '#fff', originX: 'center', originY: 'center' });
        const group = new fabric.Group([rect, text], { left: cvs.width/2, top: 580, selectable: true, originX: 'center', originY: 'center' });
        group.isBlackboard = true; cvs.add(group);
    }
    function addDoor(mode) {
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        const rect = new fabric.Rect({ width: 60, height: 10, fill: '#8D6E63', stroke: '#5D4037', strokeWidth: 1, originX: 'center', originY: 'center' });
        const doorLeaf = new fabric.Rect({ width: 60, height: 40, fill: 'rgba(141, 110, 99, 0.3)', stroke: '#8D6E63', strokeDashArray:[5,5], strokeWidth: 1, top: 25, originX: 'center', originY: 'center' });
        const text = new fabric.Text("é–€", { fontSize: 14, fill: '#3E2723', top: -15, originX: 'center', originY: 'center' });
        const group = new fabric.Group([rect, doorLeaf, text], { left: 50, top: 50, selectable: true, originX: 'center', originY: 'center' });
        cvs.add(group);
    }
    function addCustomObject(mode) {
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        const rect = new fabric.Rect({ width: 80, height: 40, fill: '#E0E0E0', stroke: '#9E9E9E', rx:5, ry:5, originX: 'center', originY: 'center' });
        const text = new fabric.IText("ç‰©é«”", { fontSize: 14, fill: '#333', originX: 'center', originY: 'center' });
        const group = new fabric.Group([rect, text], { left: 100, top: 100, selectable: true, originX: 'center', originY: 'center' });
        group.on('mousedblclick', () => {
            let newName = prompt("è«‹è¼¸å…¥æ–°åç¨±:", text.text);
            if(newName) { text.set('text', newName); cvs.renderAll(); }
        });
        cvs.add(group);
    }
    function addFreeSeat(mode) {
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        let cfg = mode === 'main' ? mainConfig : groupConfig;
        saveState(mode === 'main' ? 'seats' : 'groups');
        const desk = new fabric.Rect({ width: cfg.seatW, height: cfg.seatH, fill: 'rgba(255, 236, 179, 0.5)', stroke: '#FF9800', strokeWidth: 2, strokeDashArray: [5, 5], rx: 10, ry: 10, originX: 'center', originY: 'center' });
        const text = new fabric.IText("è‡ªç”±åº§", { fontSize: 16, fill: '#E65100', fontFamily: 'Microsoft JhengHei', fontWeight: 'bold', originX: 'center', originY: 'center', textAlign: 'center' });
        const group = new fabric.Group([desk, text], { left: cvs.width/2, top: cvs.height/2, selectable: true, hasControls: true, originX: 'center', originY: 'center' });
        group.isStudent = true; group.isFreeSeat = true; group.studentId = "";
        cvs.add(group);
    }
    function deleteSelected(mode) {
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        let placedSet = mode === 'main' ? placedMain : placedGroup;
        saveState(mode === 'main' ? 'seats' : 'groups');
        const activeObj = cvs.getActiveObject();
        if(activeObj) {
            if(activeObj.type === 'activeSelection') activeObj.forEachObject(obj => { if(obj.studentId) placedSet.delete(obj.studentId); });
            else if(activeObj.studentId) placedSet.delete(activeObj.studentId);
            cvs.remove(activeObj); cvs.discardActiveObject(); cvs.renderAll(); refreshSidebars();
        }
    }
    function clearAllSeats(mode) {
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        let placedSet = mode === 'main' ? placedMain : placedGroup;
        saveState(mode === 'main' ? 'seats' : 'groups');
        cvs.getObjects().forEach(obj => {
            if(obj.isStudent) {
                let textObj = obj.getObjects()[1];
                let seatId = obj.studentId; 
                if (obj.isFreeSeat) { textObj.set('text', "è‡ªç”±åº§"); obj.studentId = ""; }
                else {
                    let display = (seatId && parseInt(seatId) < 1000) ? (parseInt(seatId)<10 ? `0${seatId}` : seatId) : "";
                    textObj.set('text', display);
                }
            }
        });
        placedSet.clear(); cvs.renderAll(); refreshSidebars();
    }
    function rotateCanvas(mode) {
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        const cx = cvs.width / 2, cy = cvs.height / 2;
        cvs.getObjects().forEach(obj => {
            const newLeft = 2 * cx - obj.left;
            const newTop = 2 * cy - obj.top;
            obj.animate({ left: newLeft, top: newTop }, { duration: 500, onChange: cvs.renderAll.bind(cvs), easing: fabric.util.ease.easeInOutQuad });
        });
    }

    function autoSeatStudents(mode) {
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        let placedSet = mode === 'main' ? placedMain : placedGroup;
        saveState(mode === 'main' ? 'seats' : 'groups');
        const keys = Object.keys(studentMap).sort((a,b) => parseInt(a) - parseInt(b));
        const seats = cvs.getObjects().filter(o => o.isStudent); // Include Free Seats
        seats.sort((a, b) => (a.top - b.top) || (a.left - b.left));

        let studentIdx = 0;
        seats.forEach(seat => {
            let currentId = seat.studentId;
            let isOccupied = placedSet.has(currentId) && studentMap[currentId];
            if (!isOccupied && studentIdx < keys.length) {
                while(studentIdx < keys.length && placedSet.has(keys[studentIdx])) { studentIdx++; }
                if(studentIdx < keys.length) {
                    let sId = keys[studentIdx];
                    updateSeatText(seat, sId);
                    seat.studentId = sId;
                    placedSet.add(sId);
                    studentIdx++;
                }
            }
        });
        cvs.renderAll(); refreshSidebars();
    }

    function randomizeSeats(mode) {
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        let placedSet = mode === 'main' ? placedMain : placedGroup;
        saveState(mode === 'main' ? 'seats' : 'groups');
        
        const allStudentIds = Object.keys(studentMap);
        if (allStudentIds.length === 0) { alert("ç„¡å­¸ç”Ÿåå–®"); return; }
        allStudentIds.sort(() => Math.random() - 0.5);

        const seats = cvs.getObjects().filter(o => o.isStudent);
        placedSet.clear();
        
        seats.forEach((seat, index) => {
            if (index < allStudentIds.length) {
                let sId = allStudentIds[index];
                updateSeatText(seat, sId);
                seat.studentId = sId;
                placedSet.add(sId);
            } else {
                let textObj = seat.getObjects()[1];
                if (seat.isFreeSeat) { textObj.set('text', "è‡ªç”±åº§"); seat.studentId = ""; }
                else { 
                    let seatId = seat.studentId; // å˜—è©¦ä¿ç•™åŸå§‹åº§è™Ÿ
                    // è‹¥åŸå§‹åº§è™Ÿä¸Ÿå¤±(å› äº¤æ›)ï¼Œé€™è£¡æœƒæ¸…ç©ºã€‚
                    // è‹¥è¦åš´è¬¹ï¼Œéœ€åœ¨å»ºç«‹ Grid æ™‚ç¶å®š originalIdã€‚ç›®å‰ç°¡åŒ–ç‚ºæ¸…ç©º
                    textObj.set('text', ""); 
                    seat.studentId = ""; 
                }
            }
        });
        cvs.renderAll(); refreshSidebars();
    }

    function downloadConfig() {
        const config = {
            mainCanvas: canvasMain.toJSON(['studentId', 'isStudent', 'isGridLine', 'isBlackboard', 'isTeacherDesk', 'isFreeSeat', '_startLeft', '_startTop']),
            groupCanvas: canvasGroup.toJSON(['studentId', 'isStudent', 'isGridLine', 'isBlackboard', 'isTeacherDesk', 'isFreeSeat', '_startLeft', '_startTop']),
            placedMain: Array.from(placedMain), placedGroup: Array.from(placedGroup),
            cadreData: cadreData, cleaningTasks: cleaningTasks, studentMap: studentMap,
            mainConfig: mainConfig, groupConfig: groupConfig
        };
        const blob = new Blob([JSON.stringify(config)], { type: 'application/json;charset=utf-8' });
        
        // ä½¿ç”¨ FileSaver.js çš„ saveAs ä¾†è™•ç†ä¸‹è¼‰ï¼Œå®Œç¾é¿é–‹ Safari çš„ Blob é˜»æ“‹å•é¡Œ
        if (window.saveAs) {
            window.saveAs(blob, 'ç­ç´šè¨­å®š.json');
        } else {
            // å‚™ç”¨æ–¹æ¡ˆ (è¬ä¸€å¥—ä»¶æ²’è¼‰å…¥æˆåŠŸ)
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = 'ç­ç´šè¨­å®š.json'; 
            a.click();
        }
    }
	
    function loadConfig(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const config = JSON.parse(e.target.result);
            studentMap = config.studentMap || {};
            cadreData = config.cadreData || [];
            cleaningTasks = config.cleaningTasks || [];
            placedMain = new Set(config.placedMain); placedGroup = new Set(config.placedGroup);
            mainConfig = config.mainConfig || mainConfig; groupConfig = config.groupConfig || groupConfig;
            canvasMain.loadFromJSON(config.mainCanvas, () => canvasMain.renderAll());
            canvasGroup.loadFromJSON(config.groupCanvas, () => canvasGroup.renderAll());
            renderCadres(); renderCleaningList(); refreshSidebars();
            document.getElementById('inputRowsMain').value = mainConfig.rows; document.getElementById('inputColsMain').value = mainConfig.cols;
            document.getElementById('inputRowsGroup').value = groupConfig.rows; document.getElementById('inputColsGroup').value = groupConfig.cols;
            alert("è®€å–æˆåŠŸï¼");
        };
        reader.readAsText(file); input.value = '';
    }

    function refreshSidebars() {
        let cvsMode = currentMode;
        let placedSet = cvsMode === 'main' ? placedMain : placedGroup;
        const container = (cvsMode === 'main') ? document.getElementById('student-list-container') : document.getElementById('student-list-container-group');
        if(container) {
            container.innerHTML = "";
            const keys = Object.keys(studentMap).sort((a,b) => parseInt(a) - parseInt(b));
            let hasUn = false;
            keys.forEach(key => {
                if(!placedSet.has(key)) {
                    hasUn = true;
                    let name = studentMap[key];
                    let display = parseInt(key) >= 1000 ? name : (parseInt(key) < 10 ? `0${key} ${name}` : `${key} ${name}`);
                    let div = document.createElement('div');
                    div.className = 'student-tag student-draggable';
                    div.draggable = true;
                    div.innerText = display;
                    div.dataset.id = key;
                    div.ondragstart = (ev) => { ev.dataTransfer.setData("text", ev.target.innerText); ev.dataTransfer.setData("id", ev.target.dataset.id); };
                    container.appendChild(div);
                }
            });
            if(!hasUn) container.innerHTML = `<div class="text-success text-center mt-3">ğŸ‰ å…¨å“¡å·²å°±åº§</div>`;
        }
        refreshPickerSidebar('picker-cadre', 'cadre'); refreshPickerSidebar('picker-cleaning', 'cleaning');
    }

    function drop(ev, mode) {
        ev.preventDefault();
        let cvs = mode === 'main' ? canvasMain : canvasGroup;
        let placedSet = mode === 'main' ? placedMain : placedGroup;
        const studentId = ev.dataTransfer.getData("id"); 
        const pointer = cvs.getPointer(ev);
        let targetObj = null;
        cvs.getObjects().forEach(obj => { if(obj.containsPoint(pointer)) targetObj = obj; });
        saveState(mode === 'main' ? 'seats' : 'groups');

        if (targetObj && targetObj.isStudent) {
            if(targetObj.studentId) placedSet.delete(targetObj.studentId);
            targetObj.studentId = studentId; updateSeatText(targetObj, studentId); placedSet.add(studentId);
        } else {
             let cfg = mode === 'main' ? mainConfig : groupConfig;
             let slot = getClosestGridSlot(pointer.x, pointer.y, cfg);
             if(slot) {
                 let occupied = null; 
                 cvs.getObjects().forEach(o => { if(o.isStudent && !o.isFreeSeat && isAtPosition(o, slot.x, slot.y)) occupied = o; });
                 if(occupied) {
                     if(occupied.studentId) placedSet.delete(occupied.studentId);
                     occupied.studentId = studentId; updateSeatText(occupied, studentId); placedSet.add(studentId);
                 } else {
                     let desk = createStudentDesk(studentId, slot.x, slot.y, cfg.seatW, cfg.seatH, '#FFECB3');
                     updateSeatText(desk, studentId); placedSet.add(studentId); cvs.add(desk);
                 }
             }
        }
        cvs.renderAll(); refreshSidebars();
    }

    function updateSeatText(groupObj, id) {
        const textObj = groupObj.getObjects()[1];
        let name = studentMap[id] || "";
        let display = parseInt(id) >= 1000 ? name : (parseInt(id) < 10 ? `0${id}` : `${id}`);
        if(name && parseInt(id) < 1000) display += `\n${name}`;
        textObj.set('text', display); groupObj.addWithUpdate();
    }

    function isStudentUsed(displayStr, context) {
        let usedList = [];
        if (context === 'cadre') cadreData.forEach(c => { if(c.student) usedList.push(...c.student.split(',').map(s=>s.trim())); });
        else if (context === 'cleaning') cleaningTasks.forEach(t => { if(t.students) usedList.push(...t.students.split(',').map(s=>s.trim())); });
        return usedList.includes(displayStr);
    }
    
    function setActiveInput(el, type, index) {
        document.querySelectorAll('.active-target').forEach(e => e.classList.remove('active-target'));
        activeInput = { element: el, type: type, index: index };
        el.classList.add('active-target');
        if(type === 'cadre') document.getElementById('mask-cadre').classList.add('hidden');
        else if(type === 'cleaning') document.getElementById('mask-cleaning').classList.add('hidden');
        refreshSidebars(); 
    }
    function addStudentToInput(displayStr) {
        if (!activeInput) return;
        saveState(activeInput.type === 'cadre' ? 'cadres' : 'cleaning');
        let currentValue = activeInput.element.value;
        let newValue = currentValue ? `${currentValue}, ${displayStr}` : displayStr;
        activeInput.element.value = newValue;
        if (activeInput.type === 'cadre') cadreData[activeInput.index].student = newValue;
        else if (activeInput.type === 'cleaning') cleaningTasks[activeInput.index].students = newValue;
        refreshSidebars();
    }
    function renderCadres() {
        const tbody = document.getElementById('cadreList'); tbody.innerHTML = "";
        cadreData.forEach((item, index) => {
            tbody.innerHTML += `<tr><td><input type="text" class="form-control" value="${item.role}" onchange="saveState('cadres'); cadreData[${index}].role = this.value"></td><td><input type="text" class="form-control target-input" value="${item.student}" placeholder="é»æ“Šè¼¸å…¥" onclick="setActiveInput(this, 'cadre', ${index})" oninput="cadreData[${index}].student = this.value; refreshSidebars();" onchange="saveState('cadres');"></td><td><button class="btn btn-sm btn-outline-danger mb-1" onclick="removeLastPerson('cadre', ${index})">ğŸ‘¤ åˆªé™¤1äºº</button> <button class="btn btn-sm btn-danger" onclick="saveState('cadres'); cadreData.splice(${index}, 1); renderCadres();">åˆªé™¤æ•´åˆ—</button></td></tr>`;
        });
    }
    function addCadreRow() { saveState('cadres'); cadreData.push({ role: "", student: "" }); renderCadres(); }
    function renderCleaningList() {
        const tbody = document.getElementById('cleaningList'); tbody.innerHTML = "";
        cleaningTasks.forEach((task, index) => {
            tbody.innerHTML += `<tr><td><input type="text" class="form-control" value="${task.name}" onchange="saveState('cleaning'); cleaningTasks[${index}].name = this.value"></td><td><input type="number" class="form-control" value="${task.count}" style="width:70px" onchange="saveState('cleaning'); cleaningTasks[${index}].count = this.value"></td><td><input type="text" class="form-control target-input" value="${task.students}" placeholder="é»æ“Šè¼¸å…¥" onclick="setActiveInput(this, 'cleaning', ${index})" oninput="cleaningTasks[${index}].students = this.value; refreshSidebars();" onchange="saveState('cleaning');"></td><td><button class="btn btn-sm btn-outline-danger mb-1" onclick="removeLastPerson('cleaning', ${index})">ğŸ‘¤ åˆªé™¤1äºº</button> <button class="btn btn-sm btn-danger" onclick="saveState('cleaning'); cleaningTasks.splice(${index}, 1); renderCleaningList();">åˆªé™¤æ•´åˆ—</button></td></tr>`;
        });
    }
    function addCleaningTask() { saveState('cleaning'); cleaningTasks.push({ name: "", count: 1, students: "" }); renderCleaningList(); }
    function removeLastPerson(type, index) {
        saveState(type === 'cadre' ? 'cadres' : 'cleaning');
        let targetStr = type === 'cadre' ? cadreData[index].student : cleaningTasks[index].students;
        if(!targetStr) return;
        let arr = targetStr.split(',').map(s => s.trim()); arr.pop(); let newValue = arr.join(', ');
        if (type === 'cadre') { cadreData[index].student = newValue; renderCadres(); } 
        else { cleaningTasks[index].students = newValue; renderCleaningList(); }
        refreshSidebars();
    }
    function refreshPickerSidebar(containerId, context) {
        const container = document.getElementById(containerId); if(!container) return; container.innerHTML = "";
        const keys = Object.keys(studentMap).sort((a,b) => parseInt(a) - parseInt(b));
        if(keys.length === 0) { container.innerHTML = `<div class="text-muted text-center small mt-3">ç„¡åå–®</div>`; return; }
        keys.forEach(key => {
            let name = studentMap[key];
            let display = parseInt(key) >= 1000 ? name : (parseInt(key) < 10 ? `0${key} ${name}` : `${key} ${name}`);
            let div = document.createElement('div');
            let usedClass = isStudentUsed(display, context) ? 'used' : '';
            div.className = `student-tag ${usedClass}`; div.innerText = display;
            div.onclick = function() { addStudentToInput(display); };
            container.appendChild(div);
        });
    }

    function addManualStudent() {
        const input = document.getElementById('manualNameInput'); const name = input.value.trim(); if(!name) return;
        const id = (manualCounter++).toString(); studentMap[id] = name; input.value = ''; refreshSidebars();
    }
    function importStudentExcel(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            studentMap = {}; placedMain.clear(); placedGroup.clear();
            jsonData.forEach(row => {
                let num = row["åº§è™Ÿ"] || row["Number"];
                let name = row["å§“å"] || row["Name"];
                if(num && name) studentMap[num.toString()] = name;
            });
            initGridSystem('main'); initGridSystem('group'); 
            alert(`åŒ¯å…¥å®Œæˆï¼`);
        }; reader.readAsArrayBuffer(file); input.value = '';
    }
    function downloadExampleExcel() {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([["åº§è™Ÿ", "å§“å"], [1, "ç‹å°æ˜"], [2, "é™³å¤§å±±"]]);
        XLSX.utils.book_append_sheet(wb, ws, "åå–®"); XLSX.writeFile(wb, "ç¯„ä¾‹.xlsx");
    }
    function exportToWord() {
        // ... (Export Word Logic using docx.js, same as V14.1) ...
        const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, ImageRun } = docx;
        
        // Helper to convert dataURL to buffer
        function dataURLtoBuffer(dataurl) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){ u8arr[n] = bstr.charCodeAt(n); }
            return u8arr;
        }

        // Hide grids temporarily
        [canvasMain, canvasGroup].forEach(cvs => { cvs.getObjects().forEach(o => { if(o.isGridLine) o.set('opacity', 0); }); cvs.renderAll(); });
        
        const imgMain = dataURLtoBuffer(canvasMain.toDataURL({ format: 'jpeg', quality: 0.9, backgroundColor: '#FFFFFF' }));
        const imgGroup = dataURLtoBuffer(canvasGroup.toDataURL({ format: 'jpeg', quality: 0.9, backgroundColor: '#FFFFFF' }));
        
        [canvasMain, canvasGroup].forEach(cvs => { cvs.getObjects().forEach(o => { if(o.isGridLine) o.set('opacity', 1); }); cvs.renderAll(); });

        const doc = new Document({
            sections: [{
                properties: {},
                children: [
                    new Paragraph({ children: [new TextRun({ text: "ç­ç´šåº§ä½è¡¨ (ä¸€èˆ¬)", bold: true, size: 32 })] }),
                    new Paragraph({ children: [new ImageRun({ data: imgMain, transformation: { width: 550, height: 400 } })] }),
                    new Paragraph({ children: [new TextRun({ text: "åˆ†çµ„åº§ä½è¡¨", bold: true, size: 32, break: 1 })] }),
                    new Paragraph({ children: [new ImageRun({ data: imgGroup, transformation: { width: 550, height: 400 } })] }),
                    
                    new Paragraph({ children: [new TextRun({ text: "ç­ç´šå¹¹éƒ¨åå–®", bold: true, size: 32, break: 1 })] }),
                    new Table({
                        rows: [
                            new TableRow({ children: [ new TableCell({ children: [new Paragraph("è·ç¨±")], width: { size: 30, type: WidthType.PERCENTAGE } }), new TableCell({ children: [new Paragraph("è² è²¬å­¸ç”Ÿ")], width: { size: 70, type: WidthType.PERCENTAGE } }) ] }),
                            ...cadreData.map(c => new TableRow({ children: [ new TableCell({ children: [new Paragraph(c.role)] }), new TableCell({ children: [new Paragraph(c.student)] }) ] }))
                        ], width: { size: 100, type: WidthType.PERCENTAGE }
                    }),

                    new Paragraph({ children: [new TextRun({ text: "æƒåœ°å·¥ä½œåˆ†é…", bold: true, size: 32, break: 1 })] }),
                    new Table({
                        rows: [
                            new TableRow({ children: [ new TableCell({ children: [new Paragraph("å·¥ä½œé …ç›®")] }), new TableCell({ children: [new Paragraph("äººæ•¸")] }), new TableCell({ children: [new Paragraph("è² è²¬å­¸ç”Ÿ")] }) ] }),
                            ...cleaningTasks.map(t => new TableRow({ children: [ new TableCell({ children: [new Paragraph(t.name)] }), new TableCell({ children: [new Paragraph(t.count.toString())] }), new TableCell({ children: [new Paragraph(t.students)] }) ] }))
                        ], width: { size: 100, type: WidthType.PERCENTAGE }
                    })
                ]
            }]
        });

        Packer.toBlob(doc).then(blob => {
            saveAs(blob, "ç­ç´šè³‡æ–™.docx");
        });
    }
    
    function exportToExcel() {
        const wb = XLSX.utils.book_new();
        let mainRows = [["--- ä¸€èˆ¬åº§ä½ ---"]];
        let students = canvasMain.getObjects().filter(o => o.isStudent).sort((a,b) => (a.top - b.top) || (a.left - b.left));
        students.forEach(s => { let text = s.getObjects()[1].text.replace('\n', ' '); mainRows.push([text]); });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(mainRows), "åº§ä½è¡¨(ä¸€èˆ¬)");
        const wsCadres = XLSX.utils.json_to_sheet(cadreData.map(c => ({ "è·ç¨±": c.role, "è² è²¬å­¸ç”Ÿ": c.student })));
        XLSX.utils.book_append_sheet(wb, wsCadres, "å¹¹éƒ¨åå–®");
        const wsCleaning = XLSX.utils.json_to_sheet(cleaningTasks.map(t => ({ "å·¥ä½œé …ç›®": t.name, "äººæ•¸": t.count, "è² è²¬å­¸ç”Ÿ": t.students })));
        XLSX.utils.book_append_sheet(wb, wsCleaning, "æƒå€åå–®");
        XLSX.writeFile(wb, "ç­ç´šç¶“ç‡Ÿè³‡æ–™.xlsx");
    }
    function allowDrop(ev) { ev.preventDefault(); }

    window.onload = function() { 
        initGridSystem('main'); 
        initGridSystem('group'); 
        renderCadres(); 
        renderCleaningList(); 
        switchTab('seats'); 
    }
</script>

</body>
</html>